<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>REPTECH - Hist√≥rico</title>
    
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-auth.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-database.js"></script>

    <style>
        /* --- VISUAL DARK (Mesmo padr√£o do Treino Pro) --- */
        :root { 
            --bg-color: #000000; 
            --card-bg: #111111; 
            --accent-blue: #007AFF; 
            --text-gray: #8E8E93;
            --border-color: #2C2C2E;
        }
        
        body { background-color: var(--bg-color); color: white; font-family: -apple-system, sans-serif; padding: 20px; padding-bottom: 80px; margin: 0; }

        /* HEADER */
        .header { display: flex; align-items: center; margin-bottom: 30px; border-bottom: 1px solid var(--border-color); padding-bottom: 15px; }
        .btn-back { background: transparent; border: none; color: #888; font-size: 24px; cursor: pointer; padding-right: 15px; }
        h1 { font-size: 22px; font-weight: 800; margin: 0; letter-spacing: 0.5px; }

        /* FEED DE TREINO */
        .date-group { margin-bottom: 30px; }
        .date-header { 
            font-size: 14px; color: var(--text-gray); font-weight: 700; text-transform: uppercase; 
            margin-bottom: 15px; border-left: 3px solid var(--accent-blue); padding-left: 10px; 
        }

        .exercise-card { 
            background-color: var(--card-bg); border-radius: 15px; padding: 20px; 
            margin-bottom: 15px; border: 1px solid var(--border-color); 
        }

        .ex-name { font-size: 18px; font-weight: 700; color: white; margin-bottom: 12px; display: flex; justify-content: space-between; }
        .machine-badge { font-size: 10px; background: #222; color: #666; padding: 3px 6px; border-radius: 4px; font-weight: normal; align-self: center;}
        .auto-badge { color: var(--accent-blue); border: 1px solid var(--accent-blue); background: rgba(0,122,255,0.1); }

        /* TABELA DE S√âRIES DENTRO DO CARD */
        .set-row { 
            display: flex; justify-content: space-between; padding: 8px 0; 
            border-bottom: 1px solid #222; font-size: 14px; color: #ccc; 
        }
        .set-row:last-child { border-bottom: none; }
        .set-info { font-family: monospace; font-size: 15px; }
        .set-load { color: var(--accent-blue); font-weight: bold; }

        .empty-state { text-align: center; color: #666; margin-top: 50px; }
        .loading { text-align: center; color: var(--accent-blue); margin-top: 50px; }

    </style>
</head>
<body>

    <div class="header">
        <button class="btn-back" onclick="window.location.href='dashboard.html'">‚ùÆ</button>
        <h1>Hist√≥rico</h1>
    </div>

    <div id="history-feed">
        <div class="loading">Carregando seus treinos...</div>
    </div>

    <script>
        // --- API KEY ---
        const firebaseConfig = {
            apiKey: "AIzaSyDo2Vhtj4aldfEr6CHoXVWP4fhhC1GZZIo", // <--- SUA CHAVE AQUI
            authDomain: "reptech-mvp.firebaseapp.com",
            databaseURL: "https://reptech-mvp-default-rtdb.firebaseio.com",
            projectId: "reptech-mvp",
            storageBucket: "reptech-mvp.firebasestorage.app",
            messagingSenderId: "350784354776",
            appId: "1:350784354776:web:6d7c99682b8e0980ec1aad"
        };
        
        firebase.initializeApp(firebaseConfig);
        const auth = firebase.auth();
        const db = firebase.database();

        auth.onAuthStateChanged(user => {
            if (user) {
                loadHistory(user.uid);
            } else {
                window.location.href = "index.html";
            }
        });

        function loadHistory(uid) {
            const historyRef = db.ref(`usuarios/${uid}/historico`);
            
            historyRef.once('value').then(snapshot => {
                const data = snapshot.val();
                const feed = document.getElementById('history-feed');
                
                if (!data) {
                    feed.innerHTML = `<div class="empty-state">
                        <span style="font-size:40px; display:block; margin-bottom:10px;">üìâ</span>
                        Nenhum treino registrado ainda.<br>Bora treinar?
                    </div>`;
                    return;
                }

                const allSets = Object.values(data);
                // Ordena tudo por data decrescente
                allSets.sort((a, b) => new Date(b.data) - new Date(a.data));

                // L√ìGICA NOVA: Agrupar por "Sess√£o" (ou data + hora aproximada para legados)
                const groupedBySession = {};

                allSets.forEach(set => {
                    // Se tiver o ID novo, usa ele. Se for antigo, usa a Data como ID
                    let sessionKey = set.sessaoId || new Date(set.data).toLocaleDateString('pt-BR');
                    
                    if (!groupedBySession[sessionKey]) {
                        // Cria o cabe√ßalho da sess√£o (Data e Hora leg√≠veis)
                        const dateObj = new Date(set.data);
                        const formattedDate = dateObj.toLocaleDateString('pt-BR', { day: '2-digit', month: '2-digit' });
                        const formattedTime = dateObj.toLocaleTimeString('pt-BR', { hour: '2-digit', minute: '2-digit' });
                        
                        groupedBySession[sessionKey] = {
                            label: `${formattedDate} √†s ${formattedTime}`, // Ex: 21/11 √†s 14:30
                            timestamp: dateObj.getTime(), // Para ordenar
                            exercises: {}
                        };
                    }

                    const exKey = set.exercicio;
                    if (!groupedBySession[sessionKey].exercises[exKey]) {
                        groupedBySession[sessionKey].exercises[exKey] = {
                            sets: [],
                            maquina: set.maquina
                        };
                    }
                    groupedBySession[sessionKey].exercises[exKey].sets.push(set);
                });

                // Converte para array para ordenar as sess√µes corretamente
                const sessionList = Object.values(groupedBySession).sort((a, b) => b.timestamp - a.timestamp);

                let htmlContent = '';

                sessionList.forEach(session => {
                    htmlContent += `<div class="date-group"><div class="date-header">${session.label}</div>`;
                    
                    for (const [exName, details] of Object.entries(session.exercises)) {
                        const isAuto = details.maquina && details.maquina !== "Manual";
                        const badgeClass = isAuto ? "machine-badge auto-badge" : "machine-badge";
                        const badgeText = isAuto ? "SENSOR" : "LIVRE";

                        htmlContent += `
                        <div class="exercise-card">
                            <div class="ex-name">
                                ${exName} 
                                <span class="${badgeClass}">${badgeText}</span>
                            </div>
                        `;
                        
                        // Ordena s√©ries 1, 2, 3...
                        details.sets.sort((a,b) => new Date(a.data) - new Date(b.data));

                        details.sets.forEach((set, index) => {
                            htmlContent += `
                            <div class="set-row">
                                <span>S√©rie ${index + 1}</span>
                                <span class="set-info">
                                    <span class="set-load">${set.carga}kg</span> x ${set.repeticoes}
                                </span>
                            </div>`;
                        });

                        htmlContent += `</div>`; 
                    }
                    htmlContent += `</div>`; 
                });

                feed.innerHTML = htmlContent;
            });
        }
    </script>
</body>
</html>