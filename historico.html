<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>REPTECH - Hist√≥rico</title>
    
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-auth.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-database.js"></script>

    <style>
        /* --- VISUAL DARK (Mesmo padr√£o do Treino Pro) --- */
        :root { 
            --bg-color: #000000; 
            --card-bg: #111111; 
            --accent-blue: #007AFF; 
            --text-gray: #8E8E93;
            --border-color: #2C2C2E;
            --verde-energia: #1FBF77;
        }
        
        body { 
            background-color: var(--bg-color); 
            color: white; 
            font-family: -apple-system, sans-serif; 
            padding: 20px; 
            padding-bottom: 80px; 
            margin: 0; 
        }

        /* HEADER */
        .header { 
            display: flex; 
            align-items: center; 
            margin-bottom: 30px; 
            border-bottom: 1px solid var(--border-color); 
            padding-bottom: 15px; 
        }
        .btn-back { 
            background: transparent; 
            border: none; 
            color: #888; 
            font-size: 24px; 
            cursor: pointer; 
            padding-right: 15px; 
        }
        h1 { 
            font-size: 22px; 
            font-weight: 800; 
            margin: 0; 
            letter-spacing: 0.5px; 
        }

        /* CARD DE TREINO */
        .treino-card {
            background: var(--card-bg);
            border-radius: 16px;
            padding: 20px;
            margin-bottom: 15px;
            border: 1px solid var(--border-color);
            position: relative;
        }

        .treino-header {
            display: flex;
            justify-content: space-between;
            align-items: flex-start;
            margin-bottom: 15px;
        }

        .treino-info {
            flex: 1;
        }

        .treino-data {
            font-size: 12px;
            color: var(--text-gray);
            margin-bottom: 5px;
            font-weight: 600;
        }

        .treino-nome {
            font-size: 18px;
            font-weight: 700;
            color: white;
            margin-bottom: 5px;
        }

        .treino-subtitulo {
            font-size: 14px;
            color: var(--text-gray);
        }

        .btn-options {
            background: transparent;
            border: none;
            color: var(--text-gray);
            font-size: 20px;
            cursor: pointer;
            padding: 5px;
            transform: rotate(90deg);
            width: 30px;
            height: 30px;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        /* ESTAT√çSTICAS DO TREINO */
        .treino-stats {
            display: flex;
            justify-content: space-between;
            background: rgba(255,255,255,0.05);
            border-radius: 12px;
            padding: 15px;
            margin-bottom: 15px;
        }

        .stat-item {
            text-align: center;
            flex: 1;
        }

        .stat-label {
            font-size: 11px;
            color: var(--text-gray);
            text-transform: uppercase;
            margin-bottom: 5px;
            display: block;
        }

        .stat-value {
            font-size: 16px;
            font-weight: 700;
            color: white;
        }

        .recordes-badge {
            background: rgba(255, 215, 0, 0.2);
            color: #FFD700;
            border: 1px solid #FFD700;
            border-radius: 12px;
            padding: 8px 12px;
            font-size: 12px;
            font-weight: 600;
            display: flex;
            align-items: center;
            gap: 5px;
        }

        /* EXERC√çCIOS RESUMO */
        .exercicios-resumo {
            border-top: 1px solid var(--border-color);
            padding-top: 15px;
        }

        .exercicio-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 8px 0;
            border-bottom: 1px solid rgba(255,255,255,0.1);
        }

        .exercicio-item:last-child {
            border-bottom: none;
        }

        .exercicio-nome {
            font-size: 14px;
            color: white;
            flex: 1;
        }

        .exercicio-detalhes {
            font-size: 12px;
            color: var(--text-gray);
            text-align: right;
        }

        .exercicio-carga {
            color: var(--accent-blue);
            font-weight: 600;
        }

        /* MODAL DE OP√á√ïES */
        .modal-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0,0,0,0.9);
            z-index: 1000;
            display: none;
            justify-content: center;
            align-items: center;
        }

        .modal-card {
            background: var(--card-bg);
            width: 90%;
            max-width: 300px;
            border-radius: 20px;
            border: 1px solid var(--border-color);
            overflow: hidden;
        }

        .option-item {
            padding: 18px 20px;
            background: transparent;
            border: none;
            color: white;
            font-size: 16px;
            text-align: left;
            width: 100%;
            cursor: pointer;
            border-bottom: 1px solid var(--border-color);
            display: flex;
            align-items: center;
            gap: 12px;
        }

        .option-item:last-child {
            border-bottom: none;
        }

        .option-item:active {
            background: rgba(255,255,255,0.1);
        }

        .option-icon {
            font-size: 18px;
            width: 24px;
            text-align: center;
        }

        /* ESTADOS VAZIOS */
        .empty-state {
            text-align: center;
            color: var(--text-gray);
            padding: 60px 20px;
        }

        .empty-icon {
            font-size: 50px;
            margin-bottom: 15px;
            display: block;
        }

        .loading {
            text-align: center;
            color: var(--accent-blue);
            padding: 40px 20px;
        }

        .error-state {
            text-align: center;
            color: #FF453A;
            padding: 40px 20px;
        }
    </style>
</head>
<body>

    <div class="header">
        <button class="btn-back" onclick="window.location.href='dashboard.html'">‚ùÆ</button>
        <h1>Hist√≥rico de Treinos</h1>
    </div>

    <div id="history-feed">
        <div class="loading">Carregando seus treinos...</div>
    </div>

    <!-- Modal de Op√ß√µes -->
    <div class="modal-overlay" id="modal-options">
        <div class="modal-card">
            <button class="option-item" onclick="editarTreino()">
                <span class="option-icon">‚úèÔ∏è</span>
                Editar Treino
            </button>
            <button class="option-item" onclick="salvarComoRotina()">
                <span class="option-icon">üíæ</span>
                Salvar Como Rotina
            </button>
            <button class="option-item" onclick="copiarTreino()">
                <span class="option-icon">üìã</span>
                Copiar Treino
            </button>
            <button class="option-item" onclick="fecharModal()" style="color: var(--text-gray);">
                <span class="option-icon">‚úï</span>
                Cancelar
            </button>
        </div>
    </div>

    <script>
        // --- CONFIGURA√á√ÉO FIREBASE ---
        const firebaseConfig = {
            apiKey: "AIzaSyDo2Vhtj4aldfEr6CHoXVWP4fhhC1GZZIo",
            authDomain: "reptech-mvp.firebaseapp.com",
            databaseURL: "https://reptech-mvp-default-rtdb.firebaseio.com",
            projectId: "reptech-mvp",
            storageBucket: "reptech-mvp.firebasestorage.app",
            messagingSenderId: "350784354776",
            appId: "1:350784354776:web:6d7c99682b8e0980ec1aad"
        };
        
        firebase.initializeApp(firebaseConfig);
        const auth = firebase.auth();
        const db = firebase.database();

        let currentUser = null;
        let treinosAgrupados = [];
        let currentTreinoId = null;

        auth.onAuthStateChanged(user => {
            if (user) {
                currentUser = user;
                loadHistory(user.uid);
            } else {
                window.location.href = "index.html";
            }
        });

        // ‚úÖ FUN√á√ÉO PRINCIPAL PARA CARREGAR HIST√ìRICO (ATUALIZADA)
        function loadHistory(uid) {
            console.log("Carregando hist√≥rico para usu√°rio:", uid);
            
            const historyRef = db.ref(`usuarios/${uid}/historico_completo`);
            
            historyRef.once('value').then(snapshot => {
                const data = snapshot.val();
                const feed = document.getElementById('history-feed');
                
                console.log("Dados do hist√≥rico completo:", data);
                
                if (!data) {
                    feed.innerHTML = `
                        <div class="empty-state">
                            <span class="empty-icon">üìâ</span>
                            Nenhum treino registrado ainda.<br>Bora treinar?
                        </div>`;
                    return;
                }

                try {
                    // Processar treinos completos do NOVO FORMATO
                    const treinosProcessados = Object.entries(data).map(([sessionId, treino]) => {
                        const dataObj = new Date(treino.data || treino.endTime);
                        
                        // ‚úÖ PROCESSAR EXERC√çCIOS DO NOVO FORMATO
                        const exerciciosObj = {};
                        let totalVolume = 0;
                        let recordesCount = 0;
                        
                        if (treino.exercicios && Array.isArray(treino.exercicios)) {
                            treino.exercicios.forEach((ex, index) => {
                                if (!ex.nome) return;
                                
                                const setsArray = ex.s√©rie || [];
                                const melhorSet = setsArray.reduce((melhor, set) => {
                                    const peso = set.peso || 0;
                                    const reps = set.representantes || 0;
                                    const melhorPeso = melhor.peso || 0;
                                    const melhorReps = melhor.representantes || 0;
                                    
                                    // Comparar pelo volume (peso √ó reps)
                                    const setVolume = peso * reps;
                                    const melhorVolume = melhorPeso * melhorReps;
                                    
                                    return setVolume > melhorVolume ? set : melhor;
                                }, { peso: 0, representantes: 0 });
                                
                                // Calcular volume do exerc√≠cio
                                const volumeEx = setsArray.reduce((total, set) => {
                                    const peso = set.peso || 0;
                                    const reps = set.representantes || 0;
                                    return total + (peso * reps);
                                }, 0);
                                
                                totalVolume += volumeEx;
                                
                                exerciciosObj[ex.nome] = {
                                    sets: setsArray.map(s => ({
                                        kg: s.peso || 0,
                                        reps: s.representantes || 0,
                                        volume: (s.peso || 0) * (s.representantes || 0)
                                    })),
                                    maquina: ex.m√∫sculo || "Manual",
                                    maiorCarga: melhorSet.peso || 0,
                                    volume: volumeEx
                                };
                                
                                // Contar recordes (s√©ries marcadas como PR)
                                recordesCount += setsArray.filter(s => s.isPR).length;
                            });
                        }
                        
                        return {
                            sessaoId: sessionId,
                            data: treino.data || treino.endTime,
                            dataObj: dataObj,
                            exercicios: exerciciosObj,
                            recordes: recordesCount || treino.recordes || 0,
                            volumeTotal: totalVolume || treino.volumeTotal || treino.totalVolume || 0,
                            tempoEstimado: calcularTempoFormatado(treino.duracao),
                            totalSets: treino.seriesTotais || treino.totalSets || Object.values(exerciciosObj).reduce((total, ex) => total + (ex.sets?.length || 0), 0),
                            dataFormatada: dataObj.toLocaleDateString('pt-BR', {
                                weekday: 'long',
                                day: '2-digit',
                                month: 'short',
                                year: 'numeric',
                                hour: '2-digit',
                                minute: '2-digit'
                            }),
                            dataCurta: dataObj.toLocaleDateString('pt-BR', {
                                day: '2-digit',
                                month: '2-digit',
                                hour: '2-digit',
                                minute: '2-digit'
                            }),
                            nomeTreino: treino.nomeTreino || `Treino ${dataObj.toLocaleDateString('pt-BR', { day: '2-digit', month: '2-digit' })}`,
                            tempoFormatado: treino.duracao || "00:00",
                            volumeFormatado: formatarVolume(totalVolume || treino.volumeTotal || 0)
                        };
                    }).sort((a, b) => b.dataObj - a.dataObj); // Mais recentes primeiro

                    console.log("Treinos processados (novo formato):", treinosProcessados);
                    treinosAgrupados = treinosProcessados;
                    renderTreinos(treinosProcessados);

                } catch (error) {
                    console.error("Erro ao processar hist√≥rico:", error);
                    // Fallback para formato antigo se houver erro
                    loadHistoryFallback(uid);
                }
            }).catch(error => {
                console.error("Erro no Firebase:", error);
                loadHistoryFallback(uid);
            });
        }

        // ‚úÖ FUN√á√ÉO FALLBACK PARA FORMATO ANTIGO
        function loadHistoryFallback(uid) {
            console.log("Usando fallback para formato antigo");
            const historyRef = db.ref(`usuarios/${uid}/historico`);
            
            historyRef.once('value').then(snapshot => {
                const data = snapshot.val();
                const feed = document.getElementById('history-feed');
                
                console.log("Dados do hist√≥rico (formato antigo):", data);
                
                if (!data) {
                    feed.innerHTML = `
                        <div class="empty-state">
                            <span class="empty-icon">üìâ</span>
                            Nenhum treino registrado ainda.<br>Bora treinar?
                        </div>`;
                    return;
                }

                try {
                    // Agrupar por sessaoId
                    const treinosPorSessao = {};
                    
                    Object.entries(data).forEach(([key, set]) => {
                        if (!set || !set.data) {
                            console.warn("Set inv√°lido:", key, set);
                            return;
                        }

                        const sessaoId = set.sessaoId || `sessao_${new Date(set.data).getTime()}`;
                        
                        if (!treinosPorSessao[sessaoId]) {
                            treinosPorSessao[sessaoId] = {
                                sessaoId: sessaoId,
                                data: set.data,
                                dataObj: new Date(set.data),
                                exercicios: {},
                                recordes: 0,
                                volumeTotal: 0,
                                tempoEstimado: 0,
                                totalSets: 0
                            };
                        }
                        
                        const treino = treinosPorSessao[sessaoId];
                        const exNome = set.exercicio || "Exerc√≠cio sem nome";
                        
                        if (!treino.exercicios[exNome]) {
                            treino.exercicios[exNome] = {
                                sets: [],
                                maquina: set.m√∫sculo || "Manual",
                                maiorCarga: 0
                            };
                        }
                        
                        // Adicionar s√©rie do formato antigo
                        const setsArray = set.s√©rie || [];
                        setsArray.forEach(s => {
                            const peso = s.peso || 0;
                            const reps = s.representantes || 0;
                            
                            treino.exercicios[exNome].sets.push({ 
                                kg: peso, 
                                reps: reps,
                                volume: peso * reps
                            });
                            
                            // Atualizar estat√≠sticas
                            treino.volumeTotal += peso * reps;
                            treino.totalSets++;
                            treino.tempoEstimado += 3; // 3 minutos por s√©rie estimado
                            
                            // Verificar maior carga
                            if (peso > treino.exercicios[exNome].maiorCarga) {
                                treino.exercicios[exNome].maiorCarga = peso;
                            }
                        });
                    });

                    console.log("Treinos agrupados (fallback):", treinosPorSessao);

                    // Converter para array e processar
                    const treinosProcessados = Object.values(treinosPorSessao)
                        .map(treino => {
                            // Formatar dados
                            treino.dataFormatada = treino.dataObj.toLocaleDateString('pt-BR', {
                                weekday: 'long',
                                day: '2-digit',
                                month: 'short',
                                year: 'numeric',
                                hour: '2-digit',
                                minute: '2-digit'
                            });
                            
                            treino.dataCurta = treino.dataObj.toLocaleDateString('pt-BR', {
                                day: '2-digit',
                                month: '2-digit',
                                hour: '2-digit',
                                minute: '2-digit'
                            });
                            
                            treino.nomeTreino = `Treino ${treino.dataCurta}`;
                            treino.tempoFormatado = formatarTempo(treino.tempoEstimado);
                            treino.volumeFormatado = formatarVolume(treino.volumeTotal);
                            treino.recordes = 0; // No formato antigo n√£o temos info de PRs
                            
                            return treino;
                        })
                        .sort((a, b) => b.dataObj - a.dataObj);

                    console.log("Treinos processados (fallback):", treinosProcessados);
                    treinosAgrupados = treinosProcessados;
                    renderTreinos(treinosProcessados);

                } catch (error) {
                    console.error("Erro ao processar hist√≥rico (fallback):", error);
                    feed.innerHTML = `
                        <div class="error-state">
                            <span class="empty-icon">‚ö†Ô∏è</span>
                            Erro ao carregar hist√≥rico.<br>
                            <small>${error.message}</small>
                        </div>`;
                }
            }).catch(error => {
                console.error("Erro no Firebase (fallback):", error);
                document.getElementById('history-feed').innerHTML = `
                    <div class="error-state">
                        <span class="empty-icon">üö´</span>
                        Erro de conex√£o.<br>
                        <small>${error.message}</small>
                    </div>`;
            });
        }

        // ‚úÖ FUN√á√ÉO PARA RENDERIZAR TREINOS (ATUALIZADA)
        function renderTreinos(treinosArray) {
            const feed = document.getElementById('history-feed');
            
            if (!treinosArray || treinosArray.length === 0) {
                feed.innerHTML = `
                    <div class="empty-state">
                        <span class="empty-icon">üìÖ</span>
                        Nenhum treino encontrado.
                    </div>`;
                return;
            }

            let html = '';
            
            treinosArray.forEach((treino) => {
                const exercicios = Object.entries(treino.exercicios)
                    .slice(0, 3)
                    .map(([nome, dados]) => {
                        // ‚úÖ ENCONTRAR A MELHOR S√âRIE (maior volume: peso √ó reps)
                        const melhorSet = dados.sets.reduce((melhor, set) => {
                            const setValue = (set.kg || 0) * (set.reps || 0);
                            const melhorValue = (melhor.kg || 0) * (melhor.reps || 0);
                            return setValue > melhorValue ? set : melhor;
                        }, { kg: 0, reps: 0 });
                        
                        // Se n√£o encontrar s√©rie v√°lida, tentar a primeira
                        let displayKg = melhorSet.kg;
                        let displayReps = melhorSet.reps;
                        
                        if (displayKg === 0 && displayReps === 0 && dados.sets.length > 0) {
                            displayKg = dados.sets[0].kg || 0;
                            displayReps = dados.sets[0].reps || 0;
                        }
                        
                        return `
                            <div class="exercicio-item">
                                <span class="exercicio-nome">${nome}</span>
                                <span class="exercicio-detalhes">
                                    <span class="exercicio-carga">${displayKg}kg</span> 
                                    √ó ${displayReps}
                                </span>
                            </div>
                        `;
                    }).join('');

                const exerciciosExtras = Object.keys(treino.exercicios).length - 3;
                const maisExercicios = exerciciosExtras > 0 ? 
                    `<div class="exercicio-item" style="color: var(--text-gray); font-size: 12px;">
                        +${exerciciosExtras} exerc√≠cio${exerciciosExtras > 1 ? 's' : ''}
                    </div>` : '';

                html += `
                    <div class="treino-card" onclick="verRelatorio('${treino.sessaoId}')">
                        <div class="treino-header">
                            <div class="treino-info">
                                <div class="treino-data">${treino.dataFormatada}</div>
                                <div class="treino-nome">${treino.nomeTreino}</div>
                                <div class="treino-subtitulo">${Object.keys(treino.exercicios).length} exerc√≠cios</div>
                            </div>
                            <button class="btn-options" onclick="event.stopPropagation(); abrirOpcoes('${treino.sessaoId}')">‚ãØ</button>
                        </div>
                        
                        <div class="treino-stats">
                            <div class="stat-item">
                                <span class="stat-label">Tempo</span>
                                <span class="stat-value">${treino.tempoFormatado}</span>
                            </div>
                            <div class="stat-item">
                                <span class="stat-label">Volume</span>
                                <span class="stat-value">${treino.volumeFormatado}</span>
                            </div>
                            <div class="stat-item">
                                <span class="stat-label">Recordes</span>
                                <div class="recordes-badge">
                                    üèÜ ${treino.recordes}
                                </div>
                            </div>
                        </div>
                        
                        <div class="exercicios-resumo">
                            ${exercicios}
                            ${maisExercicios}
                        </div>
                    </div>
                `;
            });
            
            feed.innerHTML = html;
        }

        // ‚úÖ FUN√á√ÉO AUXILIAR: Calcular tempo formatado
        function calcularTempoFormatado(duracao) {
            if (!duracao) return 0;
            
            if (typeof duracao === 'string') {
                // Formato "HH:MM:SS"
                const parts = duracao.split(':');
                if (parts.length === 3) {
                    const horas = parseInt(parts[0]) || 0;
                    const minutos = parseInt(parts[1]) || 0;
                    return horas * 60 + minutos;
                } else if (parts.length === 2) {
                    // Formato "MM:SS"
                    const minutos = parseInt(parts[0]) || 0;
                    return minutos;
                }
            } else if (typeof duracao === 'number') {
                // Em minutos
                return duracao;
            }
            return 0;
        }

        // ‚úÖ FUN√á√ÉO AUXILIAR: Formatar volume
        function formatarVolume(volume) {
            if (volume >= 1000000) {
                return (volume / 1000000).toFixed(1) + 'M kg';
            } else if (volume >= 1000) {
                return (volume / 1000).toFixed(1) + 'k kg';
            }
            return Math.round(volume) + ' kg';
        }

        // ‚úÖ FUN√á√ÉO AUXILIAR: Formatar tempo
        function formatarTempo(minutos) {
            if (!minutos || minutos === 0) return "0min";
            
            const horas = Math.floor(minutos / 60);
            const mins = minutos % 60;
            
            if (horas > 0) {
                return `${horas}h ${mins}min`;
            } else {
                return `${mins}min`;
            }
        }

        // ‚úÖ FUN√á√ïES DO MODAL
        function abrirOpcoes(sessaoId) {
            currentTreinoId = sessaoId;
            document.getElementById('modal-options').style.display = 'flex';
        }

        function fecharModal() {
            document.getElementById('modal-options').style.display = 'none';
            currentTreinoId = null;
        }

        function verRelatorio(sessaoId) {
            // Redireciona para p√°gina de relat√≥rio detalhado
            window.location.href = `relatorio-treino.html?sessao=${encodeURIComponent(sessaoId)}`;
        }

        function editarTreino() {
            if (currentTreinoId) {
                alert("Funcionalidade de edi√ß√£o em desenvolvimento...");
                // window.location.href = `treino.html?editar=${currentTreinoId}`;
            }
            fecharModal();
        }

        function salvarComoRotina() {
            if (currentTreinoId && currentUser) {
                const treino = treinosAgrupados.find(t => t.sessaoId === currentTreinoId);
                
                if (treino) {
                    const nomeRotina = prompt("Nome da rotina:", `Treino ${treino.dataCurta}`);
                    
                    if (nomeRotina) {
                        const exercicios = Object.entries(treino.exercicios).map(([nome, dados]) => ({
                            name: nome,
                            muscleId: dados.maquina || "Manual",
                            restTime: 60
                        }));
                        
                        db.ref(`usuarios/${currentUser.uid}/rotinas`).push({
                            nome: nomeRotina,
                            exercicios: exercicios,
                            criadoEm: new Date().toISOString(),
                            origem: 'historico'
                        }).then(() => {
                            alert("Rotina salva com sucesso! üíæ");
                        }).catch(error => {
                            alert("Erro ao salvar: " + error.message);
                        });
                    }
                }
            }
            fecharModal();
        }

        function copiarTreino() {
            if (currentTreinoId) {
                alert("Funcionalidade de c√≥pia em desenvolvimento...");
                // window.location.href = `treino.html?copiar=${currentTreinoId}`;
            }
            fecharModal();
        }

        // Fechar modal ao clicar fora
        document.getElementById('modal-options').addEventListener('click', function(e) {
            if (e.target === this) {
                fecharModal();
            }
        });

        // ‚úÖ FUN√á√ÉO PARA DEBUG: Ver dados completos no console
        function debugTreino(sessaoId) {
            const treino = treinosAgrupados.find(t => t.sessaoId === sessaoId);
            if (treino) {
                console.log("Dados completos do treino:", treino);
                console.log("Exerc√≠cios:", treino.exercicios);
                
                Object.entries(treino.exercicios).forEach(([nome, dados]) => {
                    console.log(`Exerc√≠cio: ${nome}`);
                    console.log("S√©ries:", dados.sets);
                });
            }
        }
    </script>
</body>
</html>