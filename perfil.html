<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>REPTECH - Meu Perfil</title>
    
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link href="https://fonts.googleapis.com/css2?family=Nunito+Sans:wght@400;600;700;800&display=swap" rel="stylesheet">

    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-auth.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-database.js"></script>

    <style>
        /* --- DESIGN SYSTEM REPTECH --- */
        :root { 
            --bg-color: #0B0D0F;
            --card-bg: #2A2E35;
            --azul-tech: #0D3B66;
            --verde-energia: #1FBF77;
            --verde-transp: rgba(31, 191, 119, 0.15);
            --cinza-gelo: #E5E7EB;
            --cinza-texto: #9CA3AF;
            --border-color: rgba(255,255,255,0.05);
            --danger: #FF453A;
        }

        body { 
            background-color: var(--bg-color); 
            color: var(--cinza-gelo); 
            font-family: 'Nunito Sans', sans-serif;
            padding: 20px; 
            margin: 0;
            padding-bottom: 50px;
        }

        /* HEADER */
        .header { display: flex; align-items: center; margin-bottom: 20px; }
        .btn-back { background: transparent; border: none; color: var(--cinza-gelo); font-size: 24px; cursor: pointer; margin-right: 15px; }
        h1 { font-size: 22px; font-weight: 800; margin: 0; }

        /* AVATAR SECTION */
        .profile-header {
            display: flex;
            flex-direction: column;
            align-items: center;
            margin-bottom: 30px;
        }
        .avatar-circle { 
            width: 90px; height: 90px; 
            background: linear-gradient(135deg, #2A2E35, #111); 
            border-radius: 50%; 
            display: flex; align-items: center; justify-content: center; 
            font-size: 35px; 
            border: 2px solid var(--verde-energia);
            margin-bottom: 10px;
            box-shadow: 0 0 15px rgba(31, 191, 119, 0.2);
        }
        .user-name-display { font-size: 20px; font-weight: 700; color: white; }
        .user-sub-display { color: var(--cinza-texto); font-size: 14px; }

        /* GRID DE DIAGN√ìSTICO (O Pedido Principal) */
        .diagnostic-grid {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 15px;
            margin-bottom: 30px;
        }

        .diag-card {
            background: var(--card-bg);
            border: 1px solid var(--border-color);
            border-radius: 16px;
            padding: 15px;
            display: flex;
            flex-direction: column;
            justify-content: space-between;
        }

        .diag-label { font-size: 12px; color: var(--cinza-texto); font-weight: 600; margin-bottom: 5px; }
        .diag-value { font-size: 20px; font-weight: 800; color: var(--cinza-gelo); }
        .diag-sub { font-size: 11px; margin-top: 5px; font-weight: 600; }
        
        .imc-ok { color: var(--verde-energia); }
        .imc-warn { color: #F59E0B; } /* Amarelo */
        .imc-danger { color: var(--danger); } /* Vermelho */

        /* FORMUL√ÅRIO */
        .form-section {
            background: rgba(42, 46, 53, 0.5);
            border-radius: 20px;
            padding: 20px;
            border: 1px solid var(--border-color);
        }
        
        .section-title { font-size: 16px; font-weight: 700; margin-bottom: 20px; border-left: 3px solid var(--verde-energia); padding-left: 10px; }

        label { display: block; color: var(--cinza-texto); font-size: 12px; margin-bottom: 8px; font-weight: 700; text-transform: uppercase; }
        
        input, select { 
            width: 100%; 
            background-color: #15171a; 
            border: 1px solid var(--border-color); 
            padding: 15px; 
            border-radius: 10px; 
            color: white; 
            font-size: 16px; 
            box-sizing: border-box;
            font-family: 'Nunito Sans', sans-serif;
            margin-bottom: 15px;
        }
        input:focus, select:focus { outline: none; border-color: var(--verde-energia); }

        .row { display: flex; gap: 15px; }
        .col { flex: 1; }

        .btn-save { 
            width: 100%; 
            padding: 16px; 
            background: var(--verde-energia); 
            border: none; 
            border-radius: 12px; 
            color: #0B0D0F; 
            font-weight: 800; 
            font-size: 16px; 
            cursor: pointer; 
            margin-top: 10px; 
            transition: 0.2s;
        }
        .btn-save:active { transform: scale(0.98); }

    </style>
</head>
<body>

    <div class="header">
        <button class="btn-back" onclick="window.location.href='dashboard.html'">‚ùÆ</button>
        <h1>Perfil & Diagn√≥stico</h1>
    </div>

    <div class="profile-header">
        <div class="avatar-circle">üë§</div>
        <div class="user-name-display" id="display-name">Carregando...</div>
        <div class="user-sub-display">Mantenha seus dados atualizados</div>
    </div>

    <div class="diagnostic-grid">
        <div class="diag-card">
            <span class="diag-label">IMC ATUAL</span>
            <span class="diag-value" id="val-imc">--</span>
            <span class="diag-sub" id="status-imc">Calculando...</span>
        </div>
        
        <div class="diag-card">
            <span class="diag-label">PESO IDEAL (EST.)</span>
            <span class="diag-value" id="val-ideal">--</span>
            <span class="diag-sub" style="color:#888;">Baseado na altura</span>
        </div>

        <div class="diag-card">
            <span class="diag-label">META H√çDRICA</span>
            <span class="diag-value" id="val-agua">--</span>
            <span class="diag-sub" style="color:#007AFF;">35ml/kg corporal</span>
        </div>

        <div class="diag-card">
            <span class="diag-label">GASTO BASAL (TMB)</span>
            <span class="diag-value" id="val-tmb">--</span>
            <span class="diag-sub" style="color:#888;">Kcal/dia (Repouso)</span>
        </div>
    </div>

    <div class="form-section">
        <div class="section-title">Editar Dados</div>
        
        <label>Nome Completo</label>
        <input type="text" id="input-name" placeholder="Seu nome">

        <div class="row">
            <div class="col">
                <label>Idade</label>
                <input type="number" id="input-age" placeholder="Anos">
            </div>
            <div class="col">
                <label>Sexo</label>
                <select id="input-sexo">
                    <option value="masculino">Masculino</option>
                    <option value="feminino">Feminino</option>
                </select>
            </div>
        </div>

        <div class="row">
            <div class="col">
                <label>Peso (kg)</label>
                <input type="number" id="input-weight" step="0.1" placeholder="Kg">
            </div>
            <div class="col">
                <label>Altura (cm)</label>
                <input type="number" id="input-height" placeholder="Cm">
            </div>
        </div>

        <button class="btn-save" onclick="saveProfile()">SALVAR ALTERA√á√ïES</button>
    </div>

    <script>
        const firebaseConfig = {
            apiKey: "AIzaSyDo2Vhtj4aldfEr6CHoXVWP4fhhC1GZZIo",
            authDomain: "reptech-mvp.firebaseapp.com",
            databaseURL: "https://reptech-mvp-default-rtdb.firebaseio.com",
            projectId: "reptech-mvp",
            storageBucket: "reptech-mvp.firebasestorage.app",
            messagingSenderId: "350784354776",
            appId: "1:350784354776:web:6d7c99682b8e0980ec1aad"
        };
        if (!firebase.apps.length) firebase.initializeApp(firebaseConfig);
        const auth = firebase.auth();
        const db = firebase.database();

        let currentUser = null;

        auth.onAuthStateChanged(user => {
            if (user) {
                currentUser = user;
                loadProfile();
            } else {
                window.location.href = "index.html";
            }
        });

        function loadProfile() {
            db.ref('usuarios/' + currentUser.uid + '/perfil').once('value').then(snapshot => {
                const data = snapshot.val();
                if (data) {
                    // Preencher Inputs
                    if(data.nome) {
                        document.getElementById('input-name').value = data.nome;
                        document.getElementById('display-name').innerText = data.nome;
                    }
                    if(data.idade) document.getElementById('input-age').value = data.idade;
                    if(data.peso) document.getElementById('input-weight').value = data.peso;
                    if(data.altura) document.getElementById('input-height').value = data.altura;
                    if(data.sexo) document.getElementById('input-sexo').value = data.sexo;

                    // Calcular Diagn√≥sticos
                    calculateMetrics(data.peso, data.altura, data.idade, data.sexo);
                }
            });
        }

        function calculateMetrics(peso, altura, idade, sexo) {
            if(!peso || !altura) return;

            const p = parseFloat(peso);
            const a = parseFloat(altura) / 100; // converter para metros
            const age = parseInt(idade) || 25;

            // 1. IMC
            const imc = p / (a * a);
            const imcEl = document.getElementById('val-imc');
            const statusEl = document.getElementById('status-imc');
            
            imcEl.innerText = imc.toFixed(1);
            
            if(imc < 18.5) { statusEl.innerText = "Abaixo do peso"; statusEl.className = "diag-sub imc-warn"; }
            else if(imc < 24.9) { statusEl.innerText = "Peso Normal"; statusEl.className = "diag-sub imc-ok"; }
            else if(imc < 29.9) { statusEl.innerText = "Sobrepeso"; statusEl.className = "diag-sub imc-warn"; }
            else { statusEl.innerText = "Obesidade"; statusEl.className = "diag-sub imc-danger"; }

            // 2. Peso Ideal (F√≥rmula simples baseada em IMC m√©dio 22)
            const minIdeal = 18.5 * (a * a);
            const maxIdeal = 24.9 * (a * a);
            document.getElementById('val-ideal').innerText = `${minIdeal.toFixed(0)} - ${maxIdeal.toFixed(0)} kg`;

            // 3. Meta H√≠drica (35ml por kg)
            const agua = (p * 35) / 1000;
            document.getElementById('val-agua').innerText = `${agua.toFixed(1)} L`;

            // 4. TMB (Harris-Benedict)
            // Homens: 66.5 + (13.75 √ó kg) + (5.003 √ó cm) - (6.755 √ó age)
            // Mulheres: 655.1 + (9.563 √ó kg) + (1.850 √ó cm) - (4.676 √ó age)
            let tmb = 0;
            const alturaCm = parseFloat(altura);

            if (sexo === 'feminino') {
                tmb = 655.1 + (9.563 * p) + (1.850 * alturaCm) - (4.676 * age);
            } else {
                tmb = 66.5 + (13.75 * p) + (5.003 * alturaCm) - (6.755 * age);
            }
            document.getElementById('val-tmb').innerText = Math.round(tmb);
        }

        function saveProfile() {
            const nome = document.getElementById('input-name').value;
            const idade = document.getElementById('input-age').value;
            const peso = document.getElementById('input-weight').value;
            const altura = document.getElementById('input-height').value;
            const sexo = document.getElementById('input-sexo').value;

            if(!nome) return alert("Por favor, digite pelo menos seu nome.");

            const updates = {
                nome: nome,
                idade: idade,
                peso: peso,
                altura: altura,
                sexo: sexo
            };

            db.ref('usuarios/' + currentUser.uid + '/perfil').update(updates).then(() => {
                // Atualizar visual
                document.getElementById('display-name').innerText = nome;
                calculateMetrics(peso, altura, idade, sexo);
                
                // Feedback visual
                const btn = document.querySelector('.btn-save');
                const originalText = btn.innerText;
                btn.innerText = "‚úÖ SALVO!";
                btn.style.background = "#fff";
                setTimeout(() => {
                    btn.innerText = originalText;
                    btn.style.background = "var(--verde-energia)";
                }, 1500);

            }).catch(err => {
                alert("Erro ao salvar: " + err.message);
            });
        }
    </script>
</body>
</html>