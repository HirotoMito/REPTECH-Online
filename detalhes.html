<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Detalhes do Exerc√≠cio</title>
    
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-auth.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-database.js"></script>
    
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

    <style>
        :root { --bg-color: #000000; --card-bg: #111111; --accent-blue: #007AFF; --text-gray: #8E8E93; --border-color: #2C2C2E; }
        body { background-color: var(--bg-color); color: white; font-family: -apple-system, sans-serif; margin: 0; padding: 0; }

        /* HEADER */
        header { padding: 15px; border-bottom: 1px solid var(--border-color); display: flex; align-items: center; position: sticky; top: 0; background: var(--bg-color); z-index: 10; }
        .btn-back { background: transparent; border: none; color: white; font-size: 24px; cursor: pointer; margin-right: 15px; }
        h1 { font-size: 18px; margin: 0; font-weight: 700; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; }

        /* ABAS */
        .tabs { display: flex; border-bottom: 1px solid var(--border-color); }
        .tab-btn { flex: 1; padding: 15px; background: transparent; border: none; color: var(--text-gray); font-weight: 600; cursor: pointer; border-bottom: 2px solid transparent; }
        .tab-btn.active { color: var(--accent-blue); border-bottom-color: var(--accent-blue); }

        /* CONTE√öDO */
        .content-section { padding: 20px; display: none; }
        .content-section.active { display: block; }

        /* GR√ÅFICO */
        .chart-container { height: 250px; width: 100%; margin-bottom: 30px; }

        /* RECORDES */
        .stats-grid { display: grid; grid-template-columns: 1fr; gap: 15px; }
        .stat-row { display: flex; justify-content: space-between; padding: 15px; background: var(--card-bg); border-radius: 10px; border: 1px solid var(--border-color); align-items: center; }
        .stat-label { color: var(--text-gray); font-size: 14px; }
        .stat-value { font-size: 18px; font-weight: 700; color: var(--accent-blue); }
        .trophy { margin-right: 10px; }

        /* HIST√ìRICO LISTA */
        .history-item { padding: 15px; border-bottom: 1px solid var(--border-color); }
        .history-date { font-size: 12px; color: var(--text-gray); margin-bottom: 5px; font-weight: bold; }
        .history-set { display: flex; justify-content: space-between; font-size: 14px; margin-bottom: 3px; color: #ddd; }
    </style>
</head>
<body>

    <header>
        <button class="btn-back" onclick="history.back()">‚ùÆ</button>
        <h1 id="ex-title">Carregando...</h1>
    </header>

    <div class="tabs">
        <button class="tab-btn active" onclick="switchTab('resumo')">Resumo</button>
        <button class="tab-btn" onclick="switchTab('historico')">Hist√≥rico</button>
    </div>

    <div id="resumo" class="content-section active">
        <div class="chart-container">
            <canvas id="progressionChart"></canvas>
        </div>

        <h3 style="margin-bottom:15px;">üèÜ Recordes Pessoais</h3>
        <div class="stats-grid">
            <div class="stat-row">
                <span class="stat-label">Maior Peso</span>
                <span class="stat-value" id="stat-max-weight">-</span>
            </div>
            <div class="stat-row">
                <span class="stat-label">Melhor 1RM (Estimado)</span>
                <span class="stat-value" id="stat-1rm">-</span>
            </div>
            <div class="stat-row">
                <span class="stat-label">Maior Volume (Treino)</span>
                <span class="stat-value" id="stat-max-vol">-</span>
            </div>
        </div>
    </div>

    <div id="historico" class="content-section">
        <div id="history-list">
            <p style="color:#666; text-align:center; margin-top:20px;">Carregando hist√≥rico...</p>
        </div>
    </div>

    <script>
        // API KEY
        const firebaseConfig = {
            apiKey: "AIzaSyDo2Vhtj4aldfEr6CHoXVWP4fhhC1GZZIo",
            authDomain: "reptech-mvp.firebaseapp.com",
            databaseURL: "https://reptech-mvp-default-rtdb.firebaseio.com",
            projectId: "reptech-mvp",
            storageBucket: "reptech-mvp.firebasestorage.app",
            messagingSenderId: "350784354776",
            appId: "1:350784354776:web:6d7c99682b8e0980ec1aad",
            measurementId: "G-9Q9J9WRBMZ"
        };
        if (!firebase.apps.length) firebase.initializeApp(firebaseConfig);
        const auth = firebase.auth();
        const db = firebase.database();

        // Pega o nome do exerc√≠cio da URL (?exercicio=Supino...)
        const urlParams = new URLSearchParams(window.location.search);
        const exerciseName = urlParams.get('exercicio');
        document.getElementById('ex-title').innerText = exerciseName || "Detalhes";

        auth.onAuthStateChanged(user => {
            if (user && exerciseName) {
                loadExerciseData(user.uid, exerciseName);
            } else if (!user) {
                window.location.href = "index.html";
            }
        });

        function switchTab(tabName) {
            document.querySelectorAll('.content-section').forEach(el => el.classList.remove('active'));
            document.querySelectorAll('.tab-btn').forEach(el => el.classList.remove('active'));
            document.getElementById(tabName).classList.add('active');
            event.target.classList.add('active');
        }

        function loadExerciseData(uid, name) {
            db.ref(`usuarios/${uid}/historico`)
                .orderByChild('exercicio')
                .equalTo(name)
                .once('value')
                .then(snapshot => {
                    const data = snapshot.val();
                    if (!data) {
                        document.getElementById('history-list').innerHTML = "<p style='text-align:center; color:#666;'>Nenhum dado encontrado.</p>";
                        return;
                    }

                    processStats(Object.values(data));
                });
        }

        function processStats(records) {
            // Ordenar por data (Antigo -> Recente)
            records.sort((a, b) => new Date(a.data) - new Date(b.data));

            let maxWeight = 0;
            let maxVolume = 0;
            let max1RM = 0;
            
            const chartLabels = [];
            const chartData = [];
            const historyGrouped = {}; // Agrupar por sess√£o para a lista

            records.forEach(rec => {
                const kg = parseFloat(rec.carga) || 0;
                const reps = parseFloat(rec.repeticoes) || 0;
                const dateStr = new Date(rec.data).toLocaleDateString('pt-BR', {day:'2-digit', month:'2-digit'});
                
                // C√°lculos de Recordes
                if (kg > maxWeight) maxWeight = kg;
                
                // Estimativa Epley para 1RM: Peso * (1 + Reps/30)
                const estimated1RM = kg * (1 + reps/30);
                if (estimated1RM > max1RM) max1RM = estimated1RM;

                const vol = kg * reps;
                
                // Dados para o Gr√°fico (Pegamos a carga m√°xima de cada dia)
                // Simplifica√ß√£o: Adiciona ponto no gr√°fico
                chartLabels.push(dateStr);
                chartData.push(kg);

                // Agrupamento para Hist√≥rico
                const sessionKey = rec.sessaoId || dateStr;
                if(!historyGrouped[sessionKey]) {
                    historyGrouped[sessionKey] = {
                        date: new Date(rec.data).toLocaleString('pt-BR'),
                        sets: []
                    };
                }
                historyGrouped[sessionKey].sets.push({ kg, reps });
            });

            // Atualiza Tela de Resumo
            document.getElementById('stat-max-weight').innerText = `${maxWeight} kg`;
            document.getElementById('stat-1rm').innerText = `${max1RM.toFixed(1)} kg`;
            // Volume m√°ximo seria soma de uma sess√£o, aqui simplificamos para maior serie por enquanto
            document.getElementById('stat-max-vol').innerText = "-"; 

            // Renderiza Gr√°fico
            renderChart(chartLabels, chartData);

            // Renderiza Lista de Hist√≥rico (Invertida: Mais recente primeiro)
            renderHistoryList(Object.values(historyGrouped).reverse());
        }

        function renderChart(labels, dataPoints) {
            const ctx = document.getElementById('progressionChart').getContext('2d');
            new Chart(ctx, {
                type: 'line',
                data: {
                    labels: labels, // Datas
                    datasets: [{
                        label: 'Carga (kg)',
                        data: dataPoints, // Pesos
                        borderColor: '#007AFF',
                        backgroundColor: 'rgba(0, 122, 255, 0.1)',
                        borderWidth: 2,
                        pointRadius: 3,
                        tension: 0.3, // Curva suave
                        fill: true
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: { legend: { display: false } },
                    scales: {
                        y: { grid: { color: '#222' }, ticks: { color: '#666' } },
                        x: { grid: { display: false }, ticks: { color: '#666' } }
                    }
                }
            });
        }

        function renderHistoryList(sessions) {
            const container = document.getElementById('history-list');
            let html = "";
            
            sessions.forEach(session => {
                html += `<div class="history-item">
                    <div class="history-date">${session.date}</div>`;
                
                session.sets.forEach((set, idx) => {
                    html += `<div class="history-set">
                        <span>S√©rie ${idx+1}</span>
                        <span style="font-weight:bold; color:#007AFF;">${set.kg}kg x ${set.reps}</span>
                    </div>`;
                });
                
                html += `</div>`;
            });
            container.innerHTML = html;
        }
    </script>
</body>
</html>