<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>REPTECH - Treino Pro</title>
    
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-auth.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-database.js"></script>

    <script src="https://unpkg.com/html5-qrcode" type="text/javascript"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/Sortable/1.14.0/Sortable.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

    <style>
        /* ... (estilos permanecem iguais) ... */
    </style>
</head>
<body>

    <header>
        <div class="header-left">
            <button class="btn-save-routine" onclick="saveRoutine()">üíæ</button>
            <span class="header-title">Meu Treino</span>
        </div>
        <button class="btn-finish" onclick="finishWorkout()">Concluir</button>
    </header>

    <div class="stats-bar">
        <div class="stat-item"><small>Dura√ß√£o</small><span id="timer-duration">00:00:00</span></div>
        <div class="stat-item"><small>Volume</small><span id="total-vol">0 kg</span></div>
        <div class="stat-item"><small>S√©ries</small><span id="total-sets">0</span></div>
    </div>

    <div id="workout-list"></div>

    <button class="btn-add-main" onclick="openExerciseSelection()">+ ADICIONAR EXERC√çCIO</button>

    <!-- Notifica√ß√£o de PR -->
    <div id="pr-notification">
        <div class="pr-notification-icon">üèÜ</div>
        <div class="pr-notification-content">
            <div class="pr-notification-title" id="pr-notification-title">NOVO RECORDE!</div>
            <div class="pr-notification-desc" id="pr-notification-desc">Parab√©ns pelo seu progresso!</div>
        </div>
    </div>

    <div id="timer-toast">
        <div><span class="timer-label">Descanso</span></div>
        <span class="timer-display" id="rest-countdown">00:00</span>
        <button onclick="stopRest()" style="background:transparent; border:none; color:white; font-size:24px; cursor:pointer;">&times;</button>
    </div>

    <!-- Audio para o som de PR -->
    <audio id="pr-sound" preload="auto">
        <source src="https://www.soundjay.com/button/beep-07.wav" type="audio/wav">
    </audio>

    <!-- ... (modais permanecem iguais) ... -->

    <script>
        // --- CONFIGURA√á√ÉO DO BANCO DE EXERC√çCIOS ---
        const exerciseDB = {
            "Peitoral": [
                { name: "Crucifixo (Cross Over) com Halteres", img: "https://upload.wikimedia.org/wikipedia/commons/7/74/DumbbellFlye.gif" },
                { name: "Supino Reto com Barra", img: "https://i.pinimg.com/originals/8e/34/bb/8e34bb41d30ceb2f65aa7873a87a4371.gif" },
                // ... (outros exerc√≠cios)
            ],
            // ... (outras categorias)
        };

        // API KEY
        const firebaseConfig = {
            apiKey: "AIzaSyDo2Vhtj4aldfEr6CHoXVWP4fhhC1GZZIo",
            authDomain: "reptech-mvp.firebaseapp.com",
            databaseURL: "https://reptech-mvp-default-rtdb.firebaseio.com",
            projectId: "reptech-mvp",
            storageBucket: "reptech-mvp.firebasestorage.app",
            messagingSenderId: "350784354776",
            appId: "1:350784354776:web:6d7c99682b8e0980ec1aad",
            measurementId: "G-9Q9J9WRBMZ"
        };
        if (!firebase.apps.length) firebase.initializeApp(firebaseConfig);
        const auth = firebase.auth();
        const db = firebase.database();

        let currentUser = null;
        let exCount = 0;
        let html5QrcodeScanner = null;
        const workoutSessionId = Date.now(); 
        let startTime = new Date();
        let workoutInterval, restInterval;
        let currentEditingBlockId = null;
        let currentOptionsBlockId = null;
        let currentExButtonId = null;
        let activeCategory = "Todos";
        let isCategoryMenuOpen = false;
        let myChart = null;

        // --- SISTEMA DE PRs CORRIGIDO ---
        let exercisePRs = {};
        let currentSessionPRs = {};

        auth.onAuthStateChanged(user => {
            if (user) { 
                currentUser = user; 
                startWorkoutTimer(); 
                const urlParams = new URLSearchParams(window.location.search);
                const routineId = urlParams.get('rotina');
                if(routineId) loadRoutine(routineId);
                
                loadHistoricalPRs();
            } 
            else { window.location.href = "index.html"; }
        });

        // --- CARREGA PRs HIST√ìRICOS ---
        function loadHistoricalPRs() {
            if (!currentUser) return;
            
            db.ref(`usuarios/${currentUser.uid}/historico`).once('value').then(snapshot => {
                const data = snapshot.val();
                if (!data) return;
                
                const records = Object.values(data);
                
                records.forEach(record => {
                    const exerciseName = record.exercicio;
                    const kg = parseFloat(record.carga) || 0;
                    const reps = parseFloat(record.repeticoes) || 0;
                    const volume = kg * reps;
                    
                    if (!exercisePRs[exerciseName]) {
                        exercisePRs[exerciseName] = {
                            maxWeight: 0,
                            maxVolume: 0
                        };
                    }
                    
                    // Atualiza PR de CARGA (maior peso levantado)
                    if (kg > exercisePRs[exerciseName].maxWeight) {
                        exercisePRs[exerciseName].maxWeight = kg;
                    }
                    
                    // Atualiza PR de VOLUME (maior carga x repeti√ß√µes)
                    if (volume > exercisePRs[exerciseName].maxVolume) {
                        exercisePRs[exerciseName].maxVolume = volume;
                    }
                });
                
                console.log("PRs hist√≥ricos carregados:", exercisePRs);
            });
        }

        function startWorkoutTimer() {
            workoutInterval = setInterval(() => {
                const now = new Date(); const diff = Math.floor((now - startTime) / 1000);
                const h = Math.floor(diff / 3600).toString().padStart(2,'0');
                const m = Math.floor((diff % 3600) / 60).toString().padStart(2,'0');
                const s = (diff % 60).toString().padStart(2,'0');
                document.getElementById('timer-duration').innerText = `${h}:${m}:${s}`;
            }, 1000);
        }

        // --- FUN√á√ÉO PARA TOCAR SOM DE PR ---
        function playPRSound() {
            const prSound = document.getElementById('pr-sound');
            if(prSound) {
                prSound.currentTime = 0;
                prSound.play().catch(e => console.log("Som n√£o p√¥de ser reproduzido:", e));
            }
        }

        // --- NOTIFICA√á√ÉO DE PR ---
        function showPRNotification(exerciseName, prTypes, kg, reps) {
            const notification = document.getElementById('pr-notification');
            const title = document.getElementById('pr-notification-title');
            const desc = document.getElementById('pr-notification-desc');
            
            let prDescription = "";
            if (prTypes.includes("CARGA")) {
                prDescription = `Nova carga m√°xima: ${kg}kg`;
            } else if (prTypes.includes("VOLUME")) {
                prDescription = `Novo volume m√°ximo: ${kg * reps}kg`;
            }
            
            title.textContent = `üéâ ${exerciseName}`;
            desc.textContent = prDescription;
            
            notification.classList.remove('hide');
            notification.classList.add('show');
            
            playPRSound();
            
            setTimeout(() => {
                notification.classList.remove('show');
                notification.classList.add('hide');
                setTimeout(() => {
                    notification.classList.remove('hide');
                }, 500);
            }, 5000);
        }

        // --- SISTEMA DE PRs CORRIGIDO (APENAS 2 TIPOS) ---
        function checkForPRs(exerciseName, kg, reps, rowElement) {
            if (!kg || kg <= 0 || !reps || reps <= 0) return false;
            
            // Inicializa PRs do exerc√≠cio se n√£o existir
            if (!exercisePRs[exerciseName]) {
                exercisePRs[exerciseName] = {
                    maxWeight: 0,
                    maxVolume: 0
                };
            }
            
            let isPR = false;
            const prTypes = [];
            const volume = kg * reps;
            
            const currentMaxWeight = exercisePRs[exerciseName].maxWeight;
            const currentMaxVolume = exercisePRs[exerciseName].maxVolume;
            
            // --- VERIFICA√á√ÉO DE PR DE CARGA ---
            // PR de Carga: Nova carga m√°xima (independente das repeti√ß√µes)
            if (kg > currentMaxWeight) {
                exercisePRs[exerciseName].maxWeight = kg;
                prTypes.push("CARGA");
                isPR = true;
                console.log(`üèÜ NOVO PR DE CARGA em ${exerciseName}: ${kg}kg (anterior: ${currentMaxWeight}kg)`);
            }
            
            // --- VERIFICA√á√ÉO DE PR DE VOLUME ---
            // PR de Volume: Maior volume (carga x repeti√ß√µes)
            if (volume > currentMaxVolume) {
                exercisePRs[exerciseName].maxVolume = volume;
                prTypes.push("VOLUME");
                isPR = true;
                console.log(`üèÜ NOVO PR DE VOLUME em ${exerciseName}: ${volume}kg (${kg}kg x ${reps} reps)`);
            }
            
            // --- CASOS QUE N√ÉO S√ÉO PR ---
            // 1. Carga igual ao PR mas volume menor ‚Üí N√ÉO √© PR
            // 2. Volume igual ao PR mas carga menor ‚Üí N√ÉO √© PR  
            // 3. Ambos iguais aos PRs ‚Üí N√ÉO √© PR (j√° foi conquistado)
            
            if (isPR) {
                // Identificador √∫nico para evitar duplicatas na mesma sess√£o
                const prId = `${exerciseName}-${prTypes.join('-')}-${kg}-${reps}`;
                
                if (!currentSessionPRs[prId]) {
                    currentSessionPRs[prId] = true;
                    
                    // Aplica estilo de PR no bot√£o
                    const checkBtn = rowElement.querySelector('.check-btn');
                    checkBtn.classList.add('pr-record');
                    checkBtn.innerHTML = 'üèÜ<div class="pr-indicator">PR</div>';
                    
                    // Mostra notifica√ß√£o apenas para NOVOS recordes
                    showPRNotification(exerciseName, prTypes, kg, reps);
                }
            }
            
            return isPR;
        }

        // --- EXEMPLOS DO COMPORTAMENTO CORRETO ---
        /*
        S√©rie 1: 90kg x 7 ‚Üí PR (primeira vez) üèÜüéâ (CARGA e VOLUME)
        S√©rie 2: 90kg x 7 ‚Üí N√ÉO √© PR (apenas repetiu)
        S√©rie 3: 100kg x 2 ‚Üí PR üèÜüéâ (CARGA - nova carga m√°xima)
        S√©rie 4: 100kg x 5 ‚Üí N√ÉO √© PR (630kg volume vs 630kg anterior - igual)
        S√©rie 5: 95kg x 8 ‚Üí PR üèÜüéâ (VOLUME - 760kg > 630kg anterior)
        S√©rie 6: 100kg x 6 ‚Üí PR üèÜüéâ (VOLUME - 600kg > 760kg? N√ÉO - ent√£o N√ÉO √© PR)
        */

        // --- FUN√á√ÉO finishSet CORRIGIDA ---
        function finishSet(btn) {
            if (!currentUser) return;
            const row = btn.closest('tr'); 
            const inputs = row.querySelectorAll('input'); 
            const block = row.closest('.exercise-container'); 
            const machineId = block.getAttribute('data-machine'); 
            const exNameBtn = block.querySelector('.exercise-name-btn'); 
            const exName = exNameBtn.innerText; 
            const restTime = parseInt(block.getAttribute('data-rest')) || 60;
            
            const kg = parseFloat(row.querySelector('.input-kg').value) || 0;
            const reps = parseFloat(row.querySelector('.input-reps').value) || 0;
            
            if (btn.classList.contains('completed')) { 
                // Modo edi√ß√£o - remove estilos
                btn.classList.remove('completed'); 
                btn.classList.remove('pr-record');
                btn.innerHTML = '‚úî';
                
                inputs.forEach(i => i.disabled = false); 
                stopRest(); 
                
            } else { 
                // Modo conclus√£o - marca s√©rie
                btn.classList.add('completed'); 
                inputs.forEach(i => { i.disabled = true; i.classList.remove('active-sensor'); }); 
                
                // SEMPRE verifica PRs (mesmo se j√° marcou antes)
                if (kg > 0 && reps > 0) {
                    checkForPRs(exName, kg, reps, row);
                }
                
                // Salva no hist√≥rico
                db.ref(`usuarios/${currentUser.uid}/historico`).push({ 
                    exercicio: exName, 
                    carga: kg, 
                    repeticoes: reps, 
                    maquina: machineId || "Manual", 
                    data: new Date().toISOString(), 
                    sessaoId: workoutSessionId 
                }).then(() => {
                    // Atualiza PRs hist√≥ricos ap√≥s salvar
                    loadHistoricalPRs();
                }); 
                
                if (machineId && machineId !== "Manual") {
                    db.ref(`equipamentos/${machineId}/tempo_real/reset`).set(1); 
                }
                startRest(restTime); 
            }
            calculateStats();
        }

        // ... (resto das fun√ß√µes permanece igual) ...

        function calculateStats() { 
            let totalVol = 0, totalSets = 0; 
            document.querySelectorAll('.series-row').forEach(row => { 
                const kg = parseFloat(row.querySelector('.input-kg').value)||0; 
                const reps = parseFloat(row.querySelector('.input-reps').value)||0; 
                if(kg>0 && reps>0) totalVol += kg*reps; 
                if(row.querySelector('.check-btn').classList.contains('completed')) totalSets++; 
            }); 
            document.getElementById('total-vol').innerText = totalVol + " kg"; 
            document.getElementById('total-sets').innerText = totalSets; 
        }

        // --- ROTINAS ---
        function saveRoutine() {
            const exercises = [];
            document.querySelectorAll('.exercise-container').forEach(ex => {
                const name = ex.querySelector('.exercise-name-btn').innerText;
                const machineId = ex.getAttribute('data-machine');
                const restTime = ex.getAttribute('data-rest');
                if(!name.includes("Toque para selecionar")) {
                    exercises.push({ name: name, machineId: machineId, restTime: restTime });
                }
            });
            if(exercises.length === 0) { alert("Adicione exerc√≠cios antes de salvar."); return; }
            const routinesRef = db.ref(`usuarios/${currentUser.uid}/rotinas`);
            routinesRef.get().then(snapshot => {
                if(snapshot.numChildren() >= 3) { alert("Limite de 3 fichas atingido."); }
                else {
                    const routineName = prompt("Nome da Ficha:");
                    if(routineName) {
                        routinesRef.push({ nome: routineName, exercicios: exercises, criadoEm: new Date().toISOString() })
                        .then(() => alert("Ficha salva! üíæ"));
                    }
                }
            });
        }

        function finishWorkout() { 
            if(confirm("Finalizar treino?")) {
                clearInterval(workoutInterval);
                window.location.href = "dashboard.html"; 
            }
        }

        // Inicializar c√°lculos
        calculateStats();
    </script>
</body>
</html>