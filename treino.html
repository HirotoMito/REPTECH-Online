<!DOCTYPE html>
<html lang="pt-BR">
<cabe√ßa>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <t√≠tulo>REPTECH - Treino Pro</t√≠tulo>
    
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-auth.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-database.js"></script>

    <script src="https://unpkg.com/html5-qrcode" type="text/javascript"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/Sortable/1.14.0/Sortable.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

    <estilo>
        /* --- VISUAL --- */
        :root { --bg-color: #000000; --card-bg: #111111; --accent-blue: #007AFF; --input-bg: #1C1C1E; --border-color: #2C2C2E; --danger-color: #FF453A; --text-muted: #636366; --pr-gold: #FFD700; --success-green: #30D158; }
        * {box-sizing: border-box; margin: 0; padding: 0; font-family:-apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, sans-serif; }
        body { background-color: var(--bg-color); cor: branco; padding-bottom: 120px; }

        cabe√ßalho { display: flex; justify-content: space-between; align-itens: center; padding: 15px 20px; background-color: var(--bg-color); border-bottom: 1px solid var(--border-color); position: sticky; top: 0; z-index: 50; }
        .cabe√ßalho-esquerdo { display: flex; align-itens: center; gap: 15px; }
        .header-title { font-weight: 800; font-size: 18px; letter-spacing: 0.5px; }
        .btn-save-routine { background: transparente; border: none; font-size: 22px; cursor: ponteiro; padding: 0; }
        .btn-finish { background-color: var(--accent-blue); color: white; border: none; padding: 8px 16px; border-radius: 20px; font-weight: 600; font-size: 13px; cursor: ponteiro; }
        .btn-finish.editing { background-color: var(--success-green); }

        .barra de estat√≠sticas { display: flex; justify-content: space-around; padding: 15px 0; background: var(--bg-color); border-bottom: 8px solid #0a0a0a; }
        .stat-item { text-align: center; }
        .stat-item small { color: #8E8E93; font-size: 10px; text-transform: mai√∫scula; display: block; margin-bottom: 4px; }
        .stat-item span { display: block; font-size: 18px; font-weight: 700; font-variant-numeric: tabular-nums; }

        /* EXERC√çCIOS */
        .exerc√≠cio-container { padding: 20px; border-bottom: 1px solid var(--border-color); background-color: var(--bg-color); }
        .exerc√≠cio-container.auto-conectado { background: linear-gradiente(90deg, rgba(0,122,255,0.08) 0%, rgba(0,0,0,0) 100%); border-esquerda: 3px s√≥lido var(--acento-azul); }
        .exerc√≠cio-cabe√ßalho-topo { display: flex; align-itens: center; gap: 12px; margin-bottom: 5px; justify-content: space-between; }
        .ex-cabe√ßalho-esquerdo { display: flex; align-itens: center; gap: 12px; flex: 1; overflow: hidden; }
        .n√∫mero-do-exerc√≠cio {largura: 28px; altura: 28px; fundo: #333; border-radius: 50%; display: flex; align-itens: center; justify-content: center; font-weight: bold; font-size: 14px; cor: #ddd; flex-shrink: 0; }
        .nome-do-exerc√≠cio-btn { tamanho-da-fonte: 18px; peso-da-fonte: 700; cor: var(--acento-azul); fundo: transparente; borda: nenhuma; largura: 100%; text-align: left; cursor: ponteiro; overflow: oculto; text-overflow: elipsis; white-space: nowrap; }
        .btn-options { background: transparente; border: none; color: #fff; font-size: 20px; padding: 5px 10px; cursor: ponteiro; transform: rotate(90deg); }
        .rest-config-btn { background: transparente; border: none; color: var(--accent-blue); font-size: 13px; font-weight: 600; display: flex; align-itens: center; gap: 5px; margin-left: 40px; margin-bottom: 15px; cursor: pointer; opacidade: 0.9; }

        .series-table {width: 100%; border-colapse: separado; border-spacing: 0 8px; }
        .series-header th { color: #8E8E93; font-size: 10px; text-transform: mai√∫sculo; padding-bottom: 5px; font-weight: normal; }
        .series-row td { padding: 0 4px; text-align: center; vertical-align: middle; position: relative; }
        .col-prev { color: var(--text-muted); font-size: 13px; font-weight: 500; letter-spacing: 0.5px; }
        input[type="number"] {width: 100%; background-color: var(--input-bg); border: 1px solid transparente; border-radius: 8px; padding: 12px 0; color: white; text-align: center; font-size: 18px; font-weight: 600; }
        entrada:focus {border-color: var(--accent-blue); }
        sensor-ativo {border: 1px solid var(--accent-blue); box-shadow: 0 0 10px rgba(0,122,255,0.3); background-color: rgba(0,122,255,0.1); }
        .verifique-btn {width: 38px; height: 38px; background-color: var(--input-bg); border-radius: 8px; border: none; cursor: ponteiro; display: flex; align-itens: center; justify-content: center; color: #555; position: relative; }
        .check-btn.completed { background-color: #142E18; cor: #30D158; borda: 1px solid #1B4020; }
        .check-btn.pr-record { background-color: #2A2400; color: var(--pr-gold); border: 1px solid var(--pr-gold); anima√ß√£o: pulse-gold 2s infinite; }
        .pr-indicador { posi√ß√£o: absoluto; topo: -5px; direita: -5px; fundo: var(--pr-gold); cor: #000; border-radius: 50%; largura: 18px; altura: 18px; fonte-size: 10px; display: flex; align-itens: center; justify-content: center; font-weight: bold; }
        
        @keyframes pulse-gold {
            0% {caixa-sombra: 0 0 0 0 rgba(255, 215, 0, 0.4); }
            70% {box-shadow: 0 0 0 6px rgba(255, 215, 0, 0); }
            100% { box-shadow: 0 0 0 0 rgba(255, 215, 0, 0); }
        O}

        .conjuntos-a√ß√µes { display: flex; gap: 10px; margin-top: 15px; }
        .btn-add-set { flex: 2; background-color: #1C1C1E; color: var(--accent-blue); border: none; padding: 12px; border-radius: 8px; font-weight: 600; cursor: ponteiro; }
        .btn-remove-set { flex: 1; background-color: #1C1C1E; color: #666; border: none; padding: 12px; border-radius: 8px; font-weight: 600; cursor: ponteiro; }
        .btn-remove-set:active { background-color: #333; color: var(--perigo-color); }
        .btn-add-main {width: 90%; margin: 30px auto; display: block; background-color: var(--accent-blue); color: white; border: none; padding: 16px; border-radius: 12px; font-weight: 700; font-size: 16px; cursor: pointer; }

        /* NOTIFICA√á√ÉO DE PR */
        #pr-notification {
            posi√ß√£o: fixa;
            topo: 80px;
            direita: 20px;
            background: linear- gradient(135deg, #2A2400, #4a3f00);
            cor: var(--pr-gold);
            estofamento: 15px 20px;
            border-radius: 12px;
            borda: 2px solid var (--pr-gold);
            box-shadow: 0 10 px 30 px rgba(255, 215, 0, 0.3);
            √≠ndice z: 1000;
            exibi√ß√£o: nenhuma;
            align- itens: center;
            lacuna: 12px;
            largura- m√°xima: 300px;
            anima√ß√£o: slideInRight 0.5s easy-out;
        O}

        #pr-notification.show { display: flex; }
        #pr-notification.hide {anima√ß√£o: slideOutRight 0.5s ease-in forwards; }

        @keyframes slideInRight {
            de { transform: translateX(100%); opacidade: 0; }
            para {transform: translateX(0); opacidade: 1; }
        O}

        @keyframes slideOutRight {
            de {transform: translateX(0); opacidade: 1; }
            to {transform: translateX(100%); opacidade: 0; }
        O}

        .pr-notifica√ß√£o-icon { font-size: 24px; anima√ß√£o: bounce 2s infinite; }

        @keyframes bounce {
            0%, 20%, 50%, 80%, 100% { transform: translateY(0); }
            40% { transform: translateY(-5px); }
            60% { transform: translateY(-3 px); }
        O}

        .pr-notifica√ß√£o-conte√∫do { flex: 1; }
        .pr-notifica√ß√£o-title { font-weight: bold; font-size: 16px; margin-bottom: 4px; }
        .pr-notifica√ß√£o-desc { font-size: 12px; color: rgba(255, 215, 0, 0.8); }

        /* BRINDE DE SUCESSO */
        .torrada {
            posi√ß√£o: fixa;
            inferior: 30px;
            esquerda: 50%;
            transformar: translateX(-50%) translateY(100px);
            fundo: var(--success-green);
            cor: branco;
            preenchimento: 15px 25px;
            border-radius: 12px;
            font- weight: 600;
            √≠ndice z: 1001;
            exibi√ß√£o: flex;
            align- itens: center;
            lacuna: 10px;
            transi√ß√£o: transformar facilidade de 0,3 s;
            box- shadow: 0 10 px 30 px rgba(0,0,0,0.5);
        O}
        .torrar.mostrar {transformar: translateX(-50%) translateY(0); }

        /* MODAIS */
        #timer-toast { posi√ß√£o: fixa; inferior: 30px; esquerda: 50%; transform: translateX(-50%) translateY(200px); background-color: #222; border: 1px solid #333; padding: 12px 25px; border-radius: 50px; box-shadow: 0 10px 30px rgba(0,0,0,0.9); display: flex; align-itens: center; gap: 20px; transition: 0.4s; z-index: 1000; min-width: 250px; justify-content: space-between; }
        #timer-toast.visible {transform: translateX(-50%) translateY(0); }
        .timer-display { font-family: monospace; font-size: 22px; font-weight: bold; color: var(--accent-blue); }

        .modal-overlay { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.95); z-index: 200; display: none; flex-direction: column; align-itens: center; justify-content: center; }
        .modal-card { background: var(--card-bg); width: 95%; max-width: 400px; padding: 20px; border-radius: 20px; text-align: center; border: 1px solid #333; max-height: 90vh; display: flex; flex-direction: column; position: relative; }
        
        /* DESTALHES */
        .detalhes-cabe√ßalho { display: flex; align-itens: center; justify-content: space-between; margin-bottom: 20px; }
        .detalhes-title { font-size: 18px; font-weight: 700; color: white; text-align: left; }
        .detalhes-fechar { background: transparente; border: none; color: #666; font-size: 24px; cursor: ponteiro; }
        .detalhes-guias { display: flex; border-bottom: 1px solid var(--border-color); margin-bottom: 20px; }
        .d-tab-btn { flex: 1; padding: 10px; background: transparente; border: none; color: var(--text-muted); font-weight: 600; cursor: ponteiro; border-bottom: 2px solid transparente; }
        .d-tab-btn.active { color: var(--acent-blue); border-bottom-color: var(--accent-blue); }
        .detalhes-conte√∫do { flex: 1; overflow-y: auto; }
        .d-tab-content { display: none; }
        .d-tab-content.active { display: block; }
        .detalhes-gr√°fico-container { height: 200px; margin-bottom: 20px; }
        .pr-list { text-align: left; }
        .pr-item { display: flex; justify-content: space-between; padding: 12px 0; border-bottom: 1px solid var(--border-color); }
        .pr-label { color: var(--text-muted); }
        .pr-value { font-weight: 700; color: var(--pr-gold); }
        .history-list { text-align: left; max-height: 300px; overflow-y: auto; }
        .item-hist√≥ria { padding: 12px 0; border-bottom: 1px solid var(--border-color); }
        .hist√≥ria-data { font-size: 12px; color: var(--text-muted); margin-bottom: 5px; }
        .hist√≥ria-conjuntos { font-size: 14px; }

        /* LISTA DE EXERC√çCIOS */
        .exerc√≠cio-lista-container { flex: 1; overflow-y: auto; margin-top: 15px; }
        .search-box { width: 100%; padding: 12px 15px; background: #1c1c1e; border: 1px solid #333; border-radius: 10px; color: white; font-size: 16px; margin-bottom: 10px; }
        .filtro-m√∫sculo { display: flex; flex-wrap: wrap; gap: 8px; margin-bottom: 15px; justify-content: center; }
        .muscle-btn { padding: 6px 12px; background: #222; borda: 1px solid #333; border-radius: 20px; cor: #888; tamanho da fonte: 12px; cursor: ponteiro; }
        .m√∫sculo-btn.ativo { background: var(--acent-blue); color: branco; border-color: var(--accent-blue); }
        .item de exerc√≠cio {display: flex; align-items: center; padding: 15px; background: #1a1a1a; border-radius: 12px; margin-bottom: 10px; cursor: pointer; border: 1px solid transparente; transition: 0.2s; }
        .exerc√≠cio-item:active {border-color: var(--acent-blue); background: #222; }
        .exerc√≠cio-√≠cone { fonte-tamanho: 28px; margem-direita: 15px; }
        .exerc√≠cio-info { flex: 1; text-align: left; }
        .exerc√≠cio-info forte { display: block; font-size: 16px; margin-bottom: 3px; }
        .exerc√≠cio-info span { font-size: 12px; cor: #666; }

        /* OP√á√ïES MODAL */
        .options-modal { position: fixed; bottom: 0; left: 0; width: 100%; background: #1c1c1e; border-radius: 20px 20px 0 0; padding: 20px; z-index: 250; transform: translateY(100%); transition: 0.3s; }
        .O.options-modal.visible { transform: translateY(0); }
        .op√ß√µes-sobreposi√ß√£o {position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.7); z-index: 240; display: none; }
        .op√ß√µes-sobreposi√ß√£o.vis√≠vel { display: block; }
        .item de op√ß√£o {display: flex; align-items: center; gap: 15px; padding: 15px 0; border-bottom: 1px solid #333; cursor: pointer; }
        .option-item:last-child { border-bottom: none; }
        .option-item span { font-size: 20px; }
        .option-item.danger { color: var(--perigo-cor); }

        /* SCANNER QR */
        #qr-modal {√≠ndice z: 300; }
        #qr-reader {largura: 100%; max-largura: 300px; margem: 0 auto; }
        #qr-reader v√≠deo { border-radius: 12 px; }

        /* REST CONFIG */
        .op√ß√µes de descanso {display: flex; flex-wrap: wrap; gap: 10px; justify-content: center; margin: 20px 0; }
        .option-rest { padding: 12px 20px; background: #222; border: 1px solid #333; border-radius: 10px; color: branco; cursor: ponteiro; font-weight: 600; }
        .rest-option.active { background: var(--acent-blue); border-color: var(--accent-blue); }

        /* SALVAR ROTINA */
        #save-routine-modal.modal-card { text-align: left; }
        #save-routine-modal h3 { text-align: center; margin-bottom: 20px; }
        #save-routine-modal label {display: block; color: #888; font-size: 12px; margin-bottom: 5px; text-transform: mai√∫scula; }
        #save-routine-modal input {width: 100%; padding: 12px; background: #1c1c1e; border: 1px solid #333; border-radius: 10px; color: white; font-size: 16px; margin-bottom: 15px; }
        .salvar-a√ß√µes { display: flex; gap: 10px; margin-top: 10px; }
        .bot√£o Salvar-a√ß√µes {flex: 1; padding: 14px; border-radius: 10px; font-weight: 600; cursor: pointer; }
        .btn-save-confirm { background: var(--acent-blue); color: white; border: none; }
        .btn-save-cancel { background: transparente; color: #888; border: 1px solid #333; }

        /* MODAL NOVO EXERC√çCIO - NOVO */
        #add-exercise-modal {
            posi√ß√£o: fixa;
            topo: 0;
            esquerda: 0;
            largura: 100%;
            altura: 100%;
            antecedentes: rgba(0,0,0,0.85);
            √≠ndice z: 300;
            exibi√ß√£o: nenhuma;
            align- itens: center;
            justify-content: centralizar;
        O}

        #add-exercise-modal.visible {
            exibi√ß√£o: flex;
        O}

        .adicionar-cart√£o-de-exerc√≠cio {
            antecedentes: #1c1c1e;
            largura: 90%;
            largura- m√°x: 340px;
            border-radius: 20px;
            estofamento: 25px 20px;
            text-align: centrar;
        O}

        .add-exerc√≠cio-cart√£o h3 {
            fonte-tamanho: 20px;
            font- weight: 700;
            margin-bottom: 25px;
            cor: branco;
        O}

        .adicionar-op√ß√µes-de-exerc√≠cios {
            exibi√ß√£o: flex;
            flex-dire√ß√£o: coluna;
            lacuna: 12px;
        O}

        .add-exerc√≠cio-btn {
            largura: 100%¬°;
            preenchimento: 16 px 20 px;
            border-radius: 14px;
            fonte-tamanho: 16px;
            font- weight: 600;
            cursor: ponteiro;
            exibi√ß√£o: flex;
            align- itens: center;
            justify-content: centralizar;
            lacuna: 10px;
            transi√ß√£o: transformar 0.2s, opacidade 0.2s;
        O}

        .add-exerc√≠cio-btn:ativo {
            transformar: escala(0,98);
            opacidade: 0.9;
        O}

        .btn-auto-conectar {
            fundo: var(--acent-blue);
            cor: branco;
            fronteira: nenhuma;
        O}

        .btn-manual {
            antecedentes: #2c2c2e;
            cor: branco;
            borda: 1px solid #3a3a3c;
        O}

        .btn-cancel-add {
            fundo: transparente;
            fronteira: nenhuma;
            cor: #8e8e93;
            fonte-tamanho: 16px;
            font- weight: 600;
            margin-top: 15px;
            cursor: ponteiro;
            estofamento: 10px;
        O}

        .btn-cancelar-adicionar:ativo {
            cor: #636366;
        } (O)
    </estilo>
</cabe√ßa>
<corpo>

    <cabe√ßalho>
        <div class="header-left">
            <button class="btn-save-routine" onclick="openSaveRoutineModal()" title="Salvar como Ficha">üíæ</button>
            <h1 class="header-title" id="treino-title">Meu Treino</h1>
        </div>
        <button class="btn-finish" id="btn-finish" onclick="finishWorkout()">Concluir</button>
    </cabe√ßalho>

    <div class="stats-bar">
        <div class="stat-item">
            <pequeno>Dura√ß√£o</pequeno>
            <span id="stat-duration">00:00:00</span>
        </div>
        <div class="stat-item">
            <pequeno>Volume</pequeno>
            <span id="stat-volume">0 kg</span>
        </div>
        <div class="stat-item">
            <pequeno>S√©ries</pequeno>
            <span id="stat-sets">0</span>
        </div>
    </div>

    <div id="exerc√≠cios-container"></div>

    <button class="btn-add-main" onclick="openAddExerciseModal()">+ EXERC√çCIO ADICIONAR</button>

    <!-- NOTIFICA√á√ÉO DE PR -->
    <div id="pr-notifica√ß√£o">
        <span class="pr-notifica√ß√£o-icon">üèÜ</span>
        <div class="pr-notifica√ß√£o-conte√∫do">
            <div class="pr-notifica√ß√£o-titulo">NOVO RECORDE!</div>
            <div class="pr-notifica√ß√£o-desc" id="pr-notifica√ß√£o-desc">Supino Reto: 100kg</div>
        </div>
    </div>

    <!-- BRINDE -->
    <div class="toast" id="torrada">
        <span>‚úì</span>
        <span id="toast-message">Treino salvo!</span>
    </div>

    <!-- TORRADA DO TEMPORIZADOR -->
    <div id="timer-toast">
        <span class="timer-display" id="descansar-temporizador-display">00:00</span>
        <button onclick="skipRestTimer()" style="background:transparent; border:none; color:#888; font-size:14px; cursor:pointer;">Pular</button>
    </div>

    <!-- MODAL: ESCOLHER TIPO DE EXERC√çCIO - NOVO -->
    <div id="adicionar-exerc√≠cio-modal">
        <div class="adicionar-cart√£o-exerc√≠cio">
            <h3>Novo Exerc√≠cio</h3>
            <div class="add-exerc√≠cio-op√ß√µes">
                <button class="add-exercise-btn btn-auto-connect" onclick="selectAutoExercise()">
                    üì∑ Conectar M√°quina
                </bot√£o>
                <button class="add-exercise-btn btn-manual" onclick="selectManualExercise()">
                    ‚Åá Ô∏è Manual /Livre
                </bot√£o>
            </div>
            <button class="btn-cancel-add" onclick="closeAddExerciseModal()">Cancelar</button>
        </div>
    </div>

    <!-- MODAL: LISTA DE EXERC√çCIOS -->
    <div class= "modal-overlay" id="exerc√≠cio-modal">
        <div class="modal-card">
            <input type="text" class="search-box" placeholder="üîç Buscar exerc√≠cio..." oninput="filterExerc√≠cios(this.value)">
            <div class="filtro-m√∫sculo" id="filtro-m√∫sculo"></div>
            <div class="exercise-list-container" id="lista de exerc√≠cios"></div>
            <button onclick="document.getElementById('exercise-modal').style.display='none'" style="margin-top:15px; padding:12px; background:#333; border:none; border-radius:10px; color:white; width:100%; cursor:pointer;">Cancelar</button>
        </div>
    </div>

    <!-- MODAL: SCANNER QR -->
    <div class= "modal-overlay" id="qr-modal">
        <div class="modal-card">
            <h3 style="margin-bottom:20px;">üì∑ C√≥digo QR Escanear</h3>
            <div id="qr-reader"></div>
            <p style="color:#888; font-size:13px; margin:15px 0;">Aponte a c√¢mera para o QR Code do Aparelho</p>
            <button onclick="closeQRScanner()" style="padding:12px 30px; background:#333; border:none; border-radius:10px; color:white; cursor:pointer;">Cancelar</button>
        </div>
    </div>

    <!-- MODAL: DETALHES DO EXERC√çCIO -->
    <div class= "modal-overlay" id="detalhes-modal">
        <div class="modal-card">
            <div class="detalhes-cabe√ßalho">
                <h3 class="detalhes-title" id="detalhes-exercise-name">Exerc√≠cio</h3>
                <button class= "detalhes-close" onclick="fecharDetalhesModal()">‚úï</button>
            </div>
            <div class="detalhes-tabs">
                <button class="d-tab-btn active" onclick="switchDetailsTab ('progresso')">Progresso</button>
                <button class="d-tab-btn" onclick="switchDetailsTab ('history')">Hist√≥rico</button>
            </div>
            <div class="detalhes-conte√∫do">
                <div class="d-tab-content active" id="tab-progress">
                    <div class="detalhes-gr√°fico-container">
                        <canvas id="quadro-progresso"></canvas>
                    </div>
                    <div class="pr-list">
                        <div class="pr-item">
                            <span class="pr-label">Maior Peso</span>
                            <span class="pr-value" id="pr-max-weight">-</span>
                        </div>
                        <div class="pr-item">
                            <span class="pr-label">1RM Estimado</span>
                            <span class="pr-value" id="pr-1rm">-</span>
                        </div>
                        <div class="pr-item">
                            <span class="pr-label">Volume Maior</span>
                            <span class="pr-value" id="pr-max-volume">-</span>
                        </div>
                    </div>
                </div>
                <div class="d-tab-content" id="tab-history">
                    <div class="history-list" id="hist√≥ria-lista"></div>
                </div>
            </div>
        </div>
    </div>

    <!-- MODAL: CONFIGURAR DESCANSO -->
    <div class= "modal-overlay" id="rest-modal">
        <div class="modal-card">
            <h3 style="margin-bottom:10px;"> ‚Åá Ô∏è Tempo de Descanso</h3>
            <p style="color:#888; font-size:13px; margin-bottom:20px;">Selecione o intervalo entre s√©ries</p>
            <div class="rest-options" id="op√ß√µes de descanso"></div>
            <button onclick="document.getElementById('rest-modal').style.display='none'" style="margin-top:15px; padding:12px 30px; background:#333; border:none; border-radius:10px; color:white; cursor:pointer;">Fechar</button>
        </div>
    </div>

    <!-- MODAL: SALVAR FICHA -->
    <div class= "modal-overlay" id="salvar-rotina-modal">
        <div class="modal-card">
            <h3>üíæ Salvar como Ficha</h3>
            <label>Nome da Ficha</label>
            <input type="text" id="rotina-name" placeholder="Ex: Treino A - Peito e Tr√≠ceps">
            <label>Descri√ß√£o (opcional)</label>
            <input type="text" id="rotina-desc" placeholder="Ex: Foco em hipertrofia">
            <div class="salvar-a√ß√µes">
                <button class="btn-save-cancel" onclick="document.getElementById('save-routine-modal').style.display='none'">Cancelar</button>
                <button class="btn-save-confirm" onclick="saveRoutine()">Salvar</button>
            </div>
        </div>
    </div>

    <!-- OPTIONS MODAL -->
    <div class="options-overlay" id="op√ß√µes-sobreposi√ß√£o" onclick="closeOptionsModal()"></div>
    <div class="options-modal" id="op√ß√µes-modal">
        <div class="option-item" onclick="replaceExercise()">
            <span>üîÑ</span>
            <div>Substituir exerc√≠cio</div>
        </div>
        <div class="option-item" onclick="reorderExerc√≠cios()">
            <span>Ô∏èÔ∏è</span>
            <div>Reordenar</div>
        </div>
        <div class="option-item danger" onclick="removeExercise()">
            <span> ‚Åá Ô∏è</span>
            <div>Remover exerc√≠cio</div>
        </div>
    </div>

    <roteiro>
        // ========== FIREBASE CONFIG =========
        const firebaseConfig = {
            apiKey: "AIzaSyDo2Vhtj4aldfEr6CHoXVWP4fhhC1GZZIo",
            authDom√≠nio: "reptech-mvp.firebaseapp.com",
            banco de dadosURL: "https://reptech-mvp-default-rtdb.firebaseio.com",
            projectId: "reptech-mvp",
            storageBucket: "reptech-mvp.firebasestorage.app",
            mensagensSenderId: "350784354776",
            appId: "1:350784354776:web:6d7c99682b8e0980ec1aad",
            measureId: "G-9Q9J9WRBMZ"
        };
        
        se (!firebase.apps.length) firebase.initializeApp(firebaseConfig);
        const auth = firebase.auth();
        const db = firebase.database();

        // ========== VARI√ÅVEIS GLOBAIS ==========
        let currentUsu√°rio = null;
        let exerc√≠cios = [];
        let workoutStartTime = Date.now();
        deixar temporizadorInterval = null;
        deixar descansarTemporizadorIntervalo = nulo;
        let atualRestTime = 90;
        deixar selecionadoExerc√≠cio√çndice = null;
        let html5QrCode = null;
        let personalRecords = {};
        let isEditingRoutine = false;
        deixar editarRotinaId = null;
        deixar progredirGr√°fico = nulo;

        // ========== BANCO DE EXERC√çCIOS ==========
        exerc√≠cio constBanco de Dados = [
            //PEITO
            {nome: "Supino Reto", m√∫sculo: "Peito", √≠cone: " ‚Åá Ô∏è" },
            {nome: "Supino Inclinado", m√∫sculo: "Peito", √≠cone: " ‚Åá Ô∏è" },
            { nome: "Supino Declinado", m√∫sculo: "Peito", √≠cone: " ‚Åá Ô∏è" },
            {nome: "Crucifixo", m√∫sculo: "Peito", √≠cone: "ü¶ã" },
            {nome: "Crucifixo Inclinado", m√∫sculo: "Peito", √≠cone: "ü¶ã" },
            {nome: "Crossover", m√∫sculo: "Peito", √≠cone: "üîó" },
            {nome: "Peck Deck", m√∫sculo: "Peito", √≠cone: "ü¶ã" },
            {nome: "Flex√£o de Bra√ßo", m√∫sculo: "Peito", √≠cone: "üí™" },
            {nome: "Pullover", m√∫sculo: "Peito", √≠cone: " ‚Åá Ô∏è" },
            
            //COSTAS
            {nome: "Puxada Frontal", m√∫sculo: "Costas", √≠cone: "üîΩ" },
            {nome: "Puxada Aberta", m√∫sculo: "Costas", √≠cone: "üîΩ" },
            {nome: "Puxada Fechada", m√∫sculo: "Costas", √≠cone: "üîΩ" },
            {nome: "Remada Curvada", m√∫sculo: "Costas", √≠cone: "üö£" },
            {nome: "Remada Cavalinho", m√∫sculo: "Costas", √≠cone: "üö£" },
            {nome: "Remada Unilateral", m√∫sculo: "Costas", √≠cone: "üö£" },
            {nome: "Remada Baixa", m√∫sculo: "Costas", √≠cone: "üö£" },
            { nome: "Barra Fixa", m√∫sculo: "Costas", √≠cone: "üîù" },
            {nome: "Levantamento Terra", m√∫sculo: "Costas", √≠cone: " ‚Åá Ô∏è" },
            {nome: "Pulldown", m√∫sculo: "Costas", √≠cone: "üîΩ" },
            
            // OMBROS
            {nome: "Desenvolvimento", m√∫sculo: "Ombros", √≠cone: " ‚Åá Ô∏è" },
            {nome: "Desenvolvimento Halteres", m√∫sculo: "Ombros", √≠cone: " ‚Åá Ô∏è" },
            {nome: "Eleva√ß√£o Lateral", m√∫sculo: "Ombros", √≠cone: "ü¶Ö" },
            {nome: "Eleva√ß√£o Frontal", m√∫sculo: "Ombros", √≠cone: "ü¶Ö" },
            {nome: "Crucifixo Inverso", m√∫sculo: "Ombros", √≠cone: "ü¶ã" },
            {nome: "Encolhimento", m√∫sculo: "Ombros", √≠cone: "ü§∑" },
            {nome: "Face Pull", m√∫sculo: "Ombros", √≠cone: "üîó" },
            
            //B√çCEPS
            {nome: "Rosca Direta", m√∫sculo: "B√≠ceps", √≠cone: "üí™" },
            {nome: "Rosca Alternada", m√∫sculo: "B√≠ceps", √≠cone: "üí™" },
            {nome: "Rosca Martelo", m√∫sculo: "B√≠ceps", √≠cone: "üî®" },
            {nome: "Rosca Scott", m√∫sculo:" B√≠ceps", √≠cone:"üí™ " },
            {nome: "Rosca Concentrada", m√∫sculo: "B√≠ceps", √≠cone: "üí™" },
            {nome: "Rosca no Cabo", m√∫sculo: "B√≠ceps", √≠cone: "üîó" },
            
            //TR√çCEPS
            {nome: "Tr√≠ceps Pulley", m√∫sculo: "Tr√≠ceps", √≠cone: "üîΩ" },
            {nome: "Tr√≠ceps Corda", m√∫sculo: "Tr√≠ceps", √≠cone: "üîó" },
            {nome: "Tr√≠ceps Franc√™s", m√∫sculo: "Tr√≠ceps", √≠cone: " ‚Åá Ô∏è" },
            {nome: "Tr√≠ceps Testa", m√∫sculo: "Tr√≠ceps", √≠cone: " ‚Åá Ô∏è" },
            {nome: "Mergulho", m√∫sculo: "Tr√≠ceps", √≠cone: " ‚Åá Ô∏è" },
            {nome: "Tr√≠ceps Coice", m√∫sculo: "Tr√≠ceps", √≠cone: "ü¶µ" },
            
            //PERNAS
            {nome: "Agachamento Livre", m√∫sculo: "Pernas", √≠cone: " ‚Åá Ô∏è" },
            {nome: "Agachamento Smith", m√∫sculo: "Pernas", √≠cone: " ‚Åá Ô∏è" },
            {nome: "Agachamento Hack", m√∫sculo: "Pernas", √≠cone: " ‚Åá Ô∏è" },
            {nome: "Leg Press", m√∫sculo: "Pernas", √≠cone: "ü¶µ" },
            {nome: "Leg Press 45¬∞", m√∫sculo: "Pernas", √≠cone: "ü¶µ" },
            {nome: "Cadeira Extensora", m√∫sculo: "Pernas", √≠cone: "ü¶µ" },
            {nome: "Mesa Flexora", m√∫sculo: "Pernas", √≠cone: "ü¶µ" },
            {nome: "Cadeira Flexora", m√∫sculo: "Pernas", √≠cone: "ü¶µ" },
            {nome: "Cadeira Adutora", m√∫sculo: "Pernas", √≠cone: "ü¶µ" },
            {nome: "Cadeira Abdutora", m√∫sculo: "Pernas", √≠cone: "ü¶µ" },
            {nome: "Stiff", m√∫sculo: "Pernas", √≠cone: " ‚Åá Ô∏è" },
            {nome: "Passada", m√∫sculo: "Pernas", √≠cone: "üö∂" },
            {nome: "Avan√ßo", m√∫sculo: "Pernas", √≠cone: "üö∂" },
            {nome: "B√∫lgaro", m√∫sculo: "Pernas", √≠cone: "ü¶µ" },
            
            //PANTURRILHA
            {nome: "Panturrilha em P√©", m√∫sculo: "Panturrilha", √≠cone: "ü¶∂" },
            {nome: "Panturrilha Sentado", m√∫sculo: "Panturrilha", √≠cone: "ü¶∂" },
            {nome: "Panturrilha no Leg", m√∫sculo: "Panturrilha", √≠cone: "ü¶∂" },
            
            //ABD√îMEN
            {nome: "Abdominal Crunch", m√∫sculo: "Abd√¥men", √≠cone: "üî•" },
            {nome: "Abdominal Infra", m√∫sculo: "Abd√¥men", √≠cone: "üî•" },
            {nome: "Prancha", m√∫sculo: "Abd√¥men", √≠cone: "üßò" },
            {nome: "Abdominal na M√°quina", m√∫sculo: "Abd√¥men", √≠cone: "üî•" },
            {nome: "Eleva√ß√£o de Pernas", m√∫sculo: "Abd√¥men", √≠cone: "ü¶µ" },
            {nome: "Russian Twist", m√∫sculo: "Abd√¥men", √≠cone: "üîÑ" },
            
            //GL√öTEOS
            {nome: "Eleva√ß√£o P√©lvica", m√∫sculo: "Gl√∫teos", √≠cone: "üçë" },
            {nome: "Hip Thrust", m√∫sculo: "Gl√∫teos", √≠cone: "üçë" },
            {nome: "Gl√∫teo na M√°quina", m√∫sculo: "Gl√∫teos", √≠cone: "üçë" },
            {nome: "Coice no Cabo", m√∫sculo: "Gl√∫teos", √≠cone: "üçë" },
            {nome: "Abdu√ß√£o de Quadril", m√∫sculo: "Gl√∫teos", √≠cone: "üçë" }
        ];

        const muscleGrupos = [...new Set (exerciseDatabase.map(e => e.muscle))];

        // ========== INICIALIZA√á√ÉO ==========
        auth.onAuthStateMudado (usu√°rio => {
            if (usu√°rio) {
                currentUser = usu√°rio;
                initWorkout();
            } else {
                window.location.href = "index.html";
            } (O)
        });

        function initWorkout() {
            loadPersonalRecords();
            renderMuscleFilter();
            renderExerciseList();
            startWorkoutTimer();
            checkForRoutineToLoad();
            
            // Orden√°vel para reordenar
            new Sortable (document.getElementById ('exerc√≠cios-container'), {
                anima√ß√£o: 150,
                handle: '.n√∫mero de exerc√≠cio',
                onEnd: function() {
                    updateExerciseOrder();
                } (O)
            });
        } (O)

        function verificarForRoutineToLoad() {
            const urlParams = new URLSearchParams (window.location.search);
            const routineId = urlParams.get ('rotina');
            const editMode = urlParams.get ('edit');
            
            if (rotinaId) {
                loadRotina (carga derotineiroId, editMode === 'true');
            } (O)
        } (O)

        function carregarRotina (rotinaId, editMode = false) {
            db.ref(`usuarios/${currentUser.uid}/fichas/${rotinaId}`).once('value').then(snapshot => {
                const rotina = instant√¢neo.val();
                if (rotina) {
                    document.getElementById ('treino-t√≠tulo').innerText = rotineiro.nome || "Meu Treino";
                    
                    if (editMode) {
                        isEditingRoutine = true;
                        edi√ß√£oRotinaId = rotinaId;
                        document.getElementById('btn-finish').innerTexto = "Salvar";
                        document.getElementById('btn-finish').classList.add('edi√ß√£o');
                    } (O)
                    
                    if (rotina.exercicios && routine.exercicios.length > 0) {
                        routine.exercicios.forCada (ex => {
                            addExerciseToWorkout (ex.nome, ex.s√©rie || 3, ex.descanso || 90);
                        });
                    O}
                O}
            });
        O}

        // ========== MODAL NOVO EXERC√çCIO - NOVO ==========
        function abrirAdicionarExerc√≠cioModal() {
            document.getElementById('add-exercise-modal').classList.add('vis√≠vel');
        O}

        function fecharAdicionarExerc√≠cioModal() {
            document.getElementById('add-exercise-modal').classList.remove('vis√≠vel');
        O}

        function selectManualExerc√≠cio() {
            fecharAdicionarExerc√≠cioModal();
            document.getElementById('exerc√≠cio-modal').style.display = 'flex';
        O}

        function selecionarAutoExercise() {
            fecharAdicionarExerc√≠cioModal();
            openQRScanner();
        O}

        // ========== TIMER DO TREINO ==========
        function iniciarTreinoTemper() {
            timerIntervalo = setIntervalo(() => {
                const decorrido = Date.now() - workoutStartTime;
                const horas = Math.floor (afastado / 3600000);
                const minutes = Math.floor((recuado % 3600000) / 60000);
                const seconds = Math.floor((atrasado % 60000) / 1000);
                document.getElementById('stat-duration').innerTexto = 
                    `${String(horas).padStart(2, '0')}:${String(minutos).padStart(2, '0')}:${String(segundos).padStart(2, '0')}`;
            }, 1000);
        O}

        // ========== REGISTROS ==========
        function carregarRegistrosPessoais() {
            db.ref(`usuarios/${currentUser.uid}/recordes`).once('value').then(snapshot => {
                registros Pessoais = snapshot.val() || {};
            });
        O}

        function checkAndUpdatePR (nomedoexerc√≠cio, peso, reps) {
            const key = exerciseName.replace(/[^a-zA-Z0-9]/g, '_');
            const currentPR = personalRecords[key] || { maxPeso: 0, max1RM: 0 };
            const estimado1RM = peso * (1 + reps / 30);
            
            let newRecord = false;
            
            se (peso > atualPR.maxWeight) {
                currentPR.maxWeight = peso;
                newRecord = true;
            O}
            
            if (estimado1RM > atualPR.max1RM) {
                currentPR.max1RM = estimado1RM;
                newRecord = true;
            O}
            
            if (newRecord) {
                registros Pessoais[chave] = currentPR;
                db.ref(`usuarios/${currentUser.uid}/recordes/${key}`).set(currentPR);
                showPRNotifica√ß√£o (nomedoexerc√≠cio, peso);
            O}
            
            return novoGravar;
        O}

        function showPRNotifica√ß√£o (nomedoexerc√≠cio, peso) {
            notifica√ß√£o const = document.getElementById('pr-notification');
            document.getElementById('pr-notification-desc').innerTexto = `${exerciseName}: ${weight}kg`;
            notification.classList.remove('hide');
            notification.classList.add('mostrar');
            
            setTimeout(() => {
                notification.classList.add('ocultar');
                setTimeout(() => {
                    notification.classList.remove ('mostrar', 'ocultar');
                }, 500);
            }, 3000);
        O}

        // ========== FILTROS E LISTA ==========
        function renderMuscleFilter() {
            const container = document.getElementById ('filtro-m√∫sculo');
            container.innerHTML = `<button class="muscle-btn active" onclick="filterByMuscle('all', this)">Todos</button>`;
            muscleGroups.forCada (m√∫sculo => {
                container.innerHTML += `<button class="muscle-btn" onclick="filterByMuscle('${muscle}', this)">${muscle}</button>`;
            });
        O}

        function filterByMuscle (m√∫sculo, btn) {
            document.querySelectorAll('.muscle-btn').forEach(b => b.classList.remove('active'));
            btn.classList.add('ativo');
            renderExerciseList (m√∫sculo === 'todos'? nulo (: m√∫sculo);
        O}

        function filterExerc√≠cios (pesquisarTermo) {
            renderExerciseList (null, searchTerm.toLowerCase());
        } (O)

        function renderExerciseList (muscleFilter = null, procurarTerm = '') {
            const container = document.getElementById ('lista de exerc√≠cios');
            deixar filtrar = exercitarBanco de Dados;
            
            if (muscleFilter) {
                filtrado = filtred.filter(e => e.muscle === muscleFilter);
            } (O)
            
            if (procurarTermo) {
                filtrado = filtred.filter (e => 
                    e.name.toLowerCase().includes(searchTerm) || 
                    e.muscle.toLowerCase().inclui(procurarTermo)
                );
            } (O)
            
            container.innerHTML = filtred.map(ex => `
                <div class="exercise-item" onclick="addExerciseToWorkout('${ex.name}')">
                    <span class="exerc√≠cio-icon">${ex.icon}</span>
                    <div class="info-de-exerc√≠cios">
                        <strong>${ex.name}</forte>
                        <span>${ex.muscle}</span>
                    </div>
                </div>
            `).join('');
        O}

        // ========== ADICIONAR EXERC√çCIO ==========
        function adicionarExerc√≠cioParaTreino (nome, sets = 3, descansoTempo = 90) {
            const exerciseDados = exerciseBanco de dados.find (e => e.name === name) || {nome, m√∫sculo: "Outro", √≠cone: " ‚Åá Ô∏è" };
            
            exerc√≠cio const = {
                nome: exerc√≠cioData.name,
                muscle: exercitarData.m√∫sculo,
                √≠cone: exerciteData.icon,
                restTime: tempo de descanso,
                conjuntos: []
            };
            
            for (let i = 0; i < sets; i++) {
                exercice.sets.push({ reps: '', peso: '', completed: false, isPR: false });
            O}
            
            exercicios.push (exerc√≠cio);
            renderExerc√≠cios();
            document.getElementById('exerc√≠cio-modal').style.display = 'nenhum';
            
            carregarDados Anteriores(exerc√≠cioData.name, exerc√≠cios.length - 1);
        O}

        function loadDadosAnteriores(nomedoexerc√≠cio, √≠ndicedeexerc√≠cio) {
            db.ref(`usuarios/${currentUser.uid}/historico`)
                .ordemPorCrian√ßa('exerc√≠cio')
                .equalTo (nomedoexerc√≠cio)
                .limitToLast(1)
                .uma vez('valor')
                .ent√£o(instant√¢neo => {
                    dados const = snapshot.val();
                    if (dados) {
                        const lastSession = Object.values (data)[0];
                        if (√∫ltimaSess√£o && exerc√≠cios[exerc√≠cio√çndice]) {
                            exerc√≠cios[exerc√≠cio√çndice].anteriorDados = √∫ltimoSess√£o;
                            renderExerc√≠cios();
                        O}
                    O}
                });
        O}

        // ========== RENDERIZAR EXERC√çCIOS ==========
        function renderExerc√≠cios() {
            const container = document.getElementById ('exerc√≠cios-container');
            container.innerHTML = exercicios.map((ex, exIndex) => {
                const prevData = ex.anteriorDados;
                
                return `
                <div class="exerc√≠cio-container ${ex.autoConnected? 'auto-connected' : ''}" data-index="${exIndex}">
                    <div class="exerc√≠cio-cabe√ßalho-topo">
                        <div class="ex-header-left">
                            <div class="n√∫mero-exerc√≠cio">${exIndex + 1}</div>
                            <button class="exercise-name-btn" onclick="openDetailsModal (${exIndex})">${ex.name}</button>
                        </div>
                        <button class="btn-options" onclick="openOptionsModal (${exIndex})"> - - - -</button>
                    </div>
                    
                    <button class="rest-config-btn" onclick="openRestConfig(${exIndex})">
                        ‚Åá Ô∏è Descanso: ${ex.restTime}s
                    </bot√£o>
                    
                    <table class="s√©rie-tabela">
                        <thead>
                            <tr class="cabe√ßalho-da-s√©rie">
                                <th style="largura:15%">S√âRIE</th>
                                <th style="largura:25%">ANTERIOR</th>
                                <th style="largura:25%">KG</th>
                                <th style="largura:25%">REPS</th>
                                <th style="largura:10%">‚úì</th>
                            </tr>
                        </teade>
                        <tcorpo>
                            ${ex.sets.map((set, setIndex) => {
                                const prevSet = prevData?.series?.[setIndex];
                                const prevTexto = prevSet ? `${prevSet.peso}kg x ${prevSet.reps}` : '-';
                                
                                return `
                                <tr class="series-row">
                                    <td>${set√çndice + 1}</td>
                                    <td class="col-prev">${prevText}</td>
                                    <td>
                                        <input type="n√∫mero" 
                                            id="peso-${exIndex}-${setIndex}"
                                            value="${set.weight}" 
                                            espa√ßo reservado="0"
                                            onchange="updateSet(${exIndex}, ${setIndex}, 'peso', this.value)"
                                            inputmode="decimal">
                                    </td>
                                    <td>
                                        <input type="n√∫mero" 
                                            id="reps-${exIndex}-${setIndex}"
                                            value="${set.reps}" 
                                            espa√ßo reservado="0"
                                            onchange="updateSet(${exIndex}, ${setIndex}, ‚Äòreps‚Äô, this.value)"
                                            inputmode="num√©rico">
                                    </td>
                                    <td>
                                        <button class="check-btn ${set.completed? (conjunto.isPR? ‚Äòpr-record‚Äô : ‚Äòconclu√≠do‚Äô) : ‚Äò‚Äô}" 
                                            onclick="toggleSetComplete(${exIndex}, ${setIndex})">
                                            ${conjunto.conclu√≠do? (conjunto.isPR? ‚ÄòüèÜ‚Äô : ‚Äò‚úì‚Äô) : ‚Äò‚Äô}
                                            ${conjunto.√©PR? '<span class="pr-indicador">PR</span>' : ''}
                                        </bot√£o>
                                    </td>
                                </tr>
                                `;
                            }).join('')}
                        </tcorpo>
                    </tabela>
                    
                    <div class="sets-actions">
                        <button class="btn-add-set" onclick="addSet(${exIndex})">+ S√©rie</button>
                        <button class="btn-remove-set" onclick="removeSet(${exIndex})">- S√©rie</button>
                    </div>
                </div>
                `;
            }).join('');
            
            updateStats();
        } (O)

        // ========== GERENCIAR S√âRIES ==========
        function atualizaDefinir (exIndex, setIndex, campo, valor) {
            exercicios[exIndex].sets[setIndex][field] = valor;
        } (O)

        function alternarSetComplete(exIndex, setIndex) {
            const set = exercicios[exIndex].sets[setIndex];
            const weight = parseFloat(document.getElementById(`weight-${exIndex}-${setIndex}`).value) || 0;
            const reps = parseInt(document.getElementById(`reps-${exIndex}-${setIndex}`).value) || 0;
            
            set.weight = peso;
            set.reps = reps;
            set.completado = !set.completou;
            
            if (set.completed && weight > 0 && reps > 0) {
                const isPR = checkAndUpdatePR (exerc√≠cios[exIndex].name, weight, reps);
                set.isPR = isPR;
                startRestTimer (exerc√≠cios[exIndex].restTime);
            O}
            
            renderExerc√≠cios();
        O}

        function addSet (exIndex) {
            exerc√≠cios[exIndex].sets.push({ reps: '', peso: '', completed: false, isPR: false });
            renderExerc√≠cios();
        O}

        function removerConfigurar (exIndex) {
            if (exerc√≠cios[exIndex].sets.length > 1) {
                exerc√≠cios[exIndex].sets.pop();
                renderExerc√≠cios();
            O}
        O}

        // ==========ESTAT√çSTICAS ==========
        function atualizaStats() {
            let totalVolume = 0;
            let totalSets = 0;
            
            exercicios.paraCada (ex => {
                ex.sets.forCada (conjunto => {
                    if (set.completed) {
                        totalSets++;
                        totalVolume += (parseFloat(set.weight) || 0) * (parseInt(set.reps) || 0);
                    O}
                });
            });
            
            document.getElementById('stat-volume').innerTexto = `${totalVolume.toFixo(0)} kg`;
            document.getElementById('stat-sets').innerTexto = totalConjuntos;
        O}

        // ========== TIMER DE DESCANSO ==========
        function iniciarDescansarTemporizador (segundos) {
            clearInterval (descansarTemporizadorInterval);
            deixar sobrar = segundos;
            
            const toast = document.getElementById ('timer-toast');
            const display = document.getElementById ('descansar-temporizador-exibi√ß√£o');
            
            toast.classList.add('vis√≠vel');
            
            restTimerInterval = setInterval (() => {
                const mins = Math.floor (restante / 60);
                const secs = % restante 60;
                display.innerText = `${String(mins).padStart(2, '0')}:${String(secs).padStart(2, '0')}`;
                
                if (restando <= 0) {
                    clearInterval (descansarTemporizadorInterval);
                    toast.classList.remove ('vis√≠vel');
                    if ('vibrar' em navigator) navigator.vibrate(200);
                O}
                remanescente--;
            }, 1000);
        O}

        fun√ß√£o skipRestTimer() {
            clearInterval (descansarTemporizadorInterval);
            document.getElementById ('timer-toast').classList.remove ('vis√≠vel');
        O}

        // ========== CONFIG DESCANSO ==========
        function abrirRestConfig (exIndex) {
            selectedExerciseIndex = ex√çndice;
            const currentRest = exerc√≠cios[exIndex].restTime;
            op√ß√µes de const = [30, 45, 60, 90, 120, 180];
            
            const container = document.getElementById ('descansar-op√ß√µes');
            container.innerHTML = options.map(tempo => `
                <button class="rest-option ${time === currentRest? ‚Äòativo‚Äô : ‚Äò‚Äô}" 
                    onclick="setRestTime (${time})">${time}s</button>
            `).juntar-se('');
            
            document.getElementById('rest-modal').style.display = 'flex';
        O}

        function setRestTime (segundos) {
            exerc√≠cios[selecionadosExerc√≠cio√çndice].descansoTempo = segundos;
            document.getElementById('rest-modal').style.display = 'nenhum';
            renderExerc√≠cios();
        O}

        // ========== OP√á√ïES MODAL ==========
        function abrirOp√ß√µesModal (exIndex) {
            selectedExerciseIndex = ex√çndice;
            document.getElementById('options-overlay').classList.add('visible');
            document.getElementById('options-modal').classList.add('visible');
        O}

        function fecharOp√ß√µesModal() {
            document.getElementById ('options-overlay').classList.remove ('vis√≠vel');
            document.getElementById ('options-modal').classList.remove ('vis√≠vel');
        O}

        function substituirExerc√≠cio() {
            fecharOp√ß√µesModal();
            document.getElementById('exerc√≠cio-modal').style.display = 'flex';
            //Quando selecionar, substituir ao inv√©s de adicionar
            const originalAddExercise = window.addExerciseToWorkout;
            window.addExerciseToWorkout = function(nome) {
                const exerciseDados = exerciseBanco de dados.find (e => e.name === name) || {nome, m√∫sculo: "Outro", √≠cone: " ‚Åá Ô∏è" };
                exerc√≠cios[selecionadosExerc√≠cio√çndice] = {
                    nome: exerc√≠cioData.name,
                    muscle: exercitarData.m√∫sculo,
                    √≠cone: exerciteData.icon,
                    descansoTempo: 90,
                    sets: exerc√≠cios[selecionadosExerc√≠cio√çndice].sets
                };
                renderExerc√≠cios();
                document.getElementById('exerc√≠cio-modal').style.display = 'nenhum';
                window.addExerciseToWorkout = originalAdicionarExerc√≠cio;
            };
        O}

        function removerExerc√≠cio() {
            exercicios.splice (selecionadoExerc√≠cio√çndice, 1);
            fecharOp√ß√µesModal();
            renderExerc√≠cios();
        O}

        function reordenarExerc√≠cios() {
            fecharOp√ß√µesModal();
            showToast ("Arraste os n√∫meros para reordenar");
        O}

        function atualizarExerciseOrder() {
            const containers = document.querySelectorAll('.exercise-container');
            const newOrder = [];
            containers.forEach (container => {
                const index = parseInt (container.dataset.index);
                newOrder.push (exerc√≠cios[√≠ndice]);
            });
            exerc√≠cios = newOrder;
            renderExerc√≠cios();
        O}

        // ========== DESTALHES DO EXERC√çCIO ==========
        function abrirDetalhesModal (exIndex) {
            const exercise = exerc√≠cios[exIndex];
            document.getElementById('detalhes-exercise-name').innerTexto = exercise.name;
            document.getElementById('detalhes-modal').style.display = 'flex';
            
            loadExerciseDetails (exerc√≠cio.nome);
        O}

        function fecharDetalhesModal() {
            document.getElementById('detalhes-modal').style.display = 'nenhum';
        O}

        interruptor de fun√ß√£oDetailsTab (tab) {
            document.querySelectorAll('.d-tab-btn').paraEach(b => b.classList.remove('active'));
            document.querySelectorAll('.d-tab-content').paraEach(c => c.classList.remove('active'));
            
            event.target.classList.add('ativo');
            document.getElementById(`tab-${tab}`).classList.add('active');
        O}

        function carregarExerc√≠cioDetalhes (nomedoexerc√≠cio) {
            const key = exerciseName.replace(/[^a-zA-Z0-9]/g, '_');
            const pr = personalRecords[chave] || {};
            
            document.getElementById('pr-max-weight').innerTexto = pr.maxPeso? `${pr.maxWeight}kg` : '-';
            document.getElementById('pr-1rm').innerTexto = pr.max1RM? `${pr.max1RM.toFixed(1)}kg` : '-';
            document.getElementById('pr-max-volume').innerTexto = pr.maxVolume? `${pr.maxVolume}kg` : '-';
            
            // Carregar hist√≥rico
            db.ref(`usuarios/${currentUser.uid}/historico`)
                .ordemPorCrian√ßa('exerc√≠cio')
                .equalTo (nomedoexerc√≠cio)
                .limitToLast(10)
                .uma vez('valor')
                .ent√£o(instant√¢neo => {
                    const data = snapshot.val();
                    if (dados) {
                        const records = Object.values(data).sort((a, b) => new Date(a.data) - new Date(b.data));
                        renderProgressChart (registros);
                        renderHistoryList (registros);
                    O}
                });
        O}

        function renderProgressChart (registros) {
            const ctx = document.getElementById('progress-chart').getContext('2d');
            
            if (progressChart) progressoChart.destroy();
            
            const labels = records.map(r => {
                const date = new Date (r.data);
                return `${date.getDate()}/${data.getMonth() + 1}`;
            });
            
            pesos const = records.map(r => {
                const maxWeight = Math.max(...(r.series || []).map(s => s.peso || 0));
                return maxPeso;
            });
            
            progressChart = novo Gr√°fico (ctx, {
                tipo: 'linha',
                dados: {
                    labels: r√≥tulos,
                    conjuntos de dados: [{
                        gravadora: 'Carga M√°xima (kg)',
                        dados: pesos,
                        borderColor: '#007AFF',
                        backgroundColor: 'rgba(0, 122, 255, 0.1)',
                        preencher: verdade,
                        tens√£o: 0,4
                    }]
                },
                op√ß√µes: {
                    responsivo: verdade,
                    manterAspectoRatio: falso,
                    plugins: {legend: { display: false } },
                    escalas: {
                        x: {grade: { color: '#333' }, assinala: { cor: '#888' } },
                        y: {grade: { color: '#333' }, ticks: { color: '#888' } }
                    O}
                O}
            });
        O}

        function renderHist√≥riaLista (registros) {
            cont√™iner const = document.getElementById('history-list');
            container.innerHTML = records.reverse().map(r => `
                <div class="hist√≥ria-item">
                    <div class="history-date">${new Date(r.data).toLocaleDateString ('pt-BR')}</div>
                    <div class="hist√≥ria-conjuntos">
                        ${(r.series || []).map((s, i) => `S√©rie ${i+1}: ${s.peso}kg x ${s.reps}`).join('<br>')}
                    </div>
                </div>
            `).join('');
        O}

        // ========== QR SCANNER ==========
        function abrirQRScanner() {
            document.getElementById('qr-modal').style.display = 'flex';
            
            html5QrCode = new Html5Qrcode("qr-reader");
            html5QrCode.start(
                { faceingMode: "ambiente" },
                {fps: 10, qrbox: 250 },
                onQRCodeSucesso,
                onQRCodeErro
            ).catch(err => {
                console.error("Erro ao iniciar c√¢mera:", err);
                alert ("N√£o foi poss√≠vel acessar a c√¢mera");
                fecharQRScanner();
            });
        O}

        function fecharQRScanner() {
            if (html5QrCode) {
                html5QrCode.stop().then(() => {
                    html5QrCode = null;
                }).catch(err => console.error (err));
            O}
            document.getElementById('qr-modal').style.display = 'nenhum';
        O}

        function onQRCodeSuccess (TextoDecodificado) {
            fecharQRScanner();
            
            // Formato esperado: REPTECH:NomeDoExerc√≠cio
            if (decodificadoText.startsWith('REPTECH:')) {
                const exerciceName = decodificadText.replace ('REPTECH:', '');
                const exercise = exerc√≠cioBanco de Dados.find (e => e.name === exerciseName);
                
                if (exerc√≠cio) {
                    addExerciseToWorkout (exerc√≠cio.nome);
                    //Marcar como conectado automaticamente
                    exerc√≠cios[exerc√≠cios.comprimento - 1].autoConnected = true;
                    renderExerc√≠cios();
                    showToast(`${exercise.name} conectado!`);
                } else {
                    alert(`Exerc√≠cio "${exerciseName}" n√£o encontrado no banco de dados.`);
                } (O)
            } else {
                alert ("C√≥digo QR inv√°lido. Use um QR Code REPTECH.")¬°;
            } (O)
        } (O)

        function onQRCodeError (erro) {
            // Ignorar erros de leitura cont√≠nua
        } (O)

        // ========== SALVAR FICHA ===========
        function abrirSalvarRotinaModal() {
            document.getElementById('salvar-rotina-modal').style.display = 'flex';
            document.getElementById('nome-rotina').value = document.getElementById('t√≠tulo-treino').textoInterno;
        O}

        function salvarRotina() {
            const name = document.getElementById ('nome-da-rotina').value.trim();
            const desc = document.getElementById ('rotina-desc').value.trim();
            
            se (!nome) {
                alert ("Digite um nome para a ficha");
                retorno;
            O}
            
            const rotinDados = {
                nome: nome,
                descricao: desc,
                exercicios: exercicios.map(ex => ({
                    nome: ex.nome,
                    m√∫sculo: ex.m√∫sculo,
                    s√©rie: ex.sets.length,
                    descanso: ex.restTempo
                })),
                criadoEm: new Date().toISOString(),
                atualiza√ß√£oEm: new Date().toISOString()
            };
            
            const routtinId = editandoRotinaId || db.ref().child('fichas').push().key;
            
            db.ref(`usuarios/${currentUser.uid}/fichas/${rotinaId}`).set(dadosRotin√°rios)
                .ent√£o(() => {
                    document.getElementById('salvar-rotina-modal').style.display = 'nenhum';
                    showToast ("Ficha salva com sucesso!")¬°;
                })
                .pegar(err => {
                    console.error (err);
                    alert ("Erro ao salvar ficha");
                });
        O}

        // ========== TREINO FINALIZAR ==========
        function terminarTreino() {
            if (isEditingRoutine) {
                salvarRotinaFromEdit();
                retorno;
            O}
            
            if (exerc√≠cios.comprimento === 0) {
                alert ("Adicione pelo menos um exerc√≠cio");
                retorno;
            O}
            
            const completedSets = exercicios.flatMap(ex => ex.sets.filter(s => s.completed));
            if (completedSets.length === 0) {
                se (!confirme("Nenhuma s√©rie foi completada. Deseja finalizar mesmo assim?")) {
                    retorno;
                O}
            O}
            
            saveWorkoutToHistory();
        O}

        function salvarRotinaFromEdit() {
            const rotinDados = {
                nome: document.getElementById('treino-t√≠tulo').innerTexto,
                exercicios: exercicios.map(ex => ({
                    nome: ex.nome,
                    m√∫sculo: ex.m√∫sculo,
                    s√©rie: ex.sets.length,
                    descanso: ex.restTempo
                })),
                atualiza√ß√£oEm: new Date().toISOString()
            };
            
            db.ref(`usuarios/${currentUser.uid}/fichas/${editingRoutineId}`).update (rotinaData)
                .ent√£o(() => {
                    showToast ("Ficha atualizada!")¬°;
                    setTimeout(() => {
                        window.location.href = "painel.html";
                    }, 1500);
                });
        O}

        function salvarWorkoutToHistory() {
            const sessaoId = Date.now();
            const duration = Date.now() - workoutStartTime;
            
            let totalVolume = 0;
            let totalSets = 0;
            let recordsCount = 0;
            
            const exerciciosDados = exercicios.map(ex => {
                const completedSets = ex.sets.filter (s => s.completado);
                completedSets.forCada (s => {
                    totalVolume += (parseFloat (s. weight) || 0) * (parseInt (s.reps) || 0);
                    totalSets++;
                    if (s.isPR) recordsCount++;
                });
                
                retorno {
                    nome: ex.nome,
                    m√∫sculo: ex.m√∫sculo,
                    s√©rie: completedSets.map(s => ({
                        peso: parseFloat (s.weight) || 0,
                        representantes: parseInt (s.reps) || 0,
                        isPR: s.isPR || false
                    }))
                };
            }).filter(ex => ex.series.length > 0);
            
            // Salvar no hist√≥rico completo
            const malha√ß√£oDados = {
                sessaoId: sessaoId,
                dados: new Date().toISOString(),
                duracao: dura√ß√£o,
                volumeTotal: totalVolume,
                s√©riesTotais: totalSets,
                recordes: recordesContar,
                exercicios: exerc√≠ciosDados,
                nomeTreino: document.getElementById ('treino-t√≠tulo').innerTexto
            };
            
            db.ref(`usuarios/${currentUser.uid}/historico_completo/${sessaoId}`).set(workoutData);
            
            // Salvar cada exerc√≠cio individualmente para estat√≠sticas
            exerc√≠ciosDados.paraCada (ex => {
                hist√≥rico constEntry = {
                    exercicio: ex.nome,
                    m√∫sculo: ex.m√∫sculo,
                    dados: new Date().toISOString(),
                    sessaoId: sessaoId,
                    s√©rie: ex.series
                };
                
                db.ref(`usuarios/${currentUser.uid}/historico`).push(historyEntry);
            });
            
            showToast ("Treino salvo com sucesso! üí™");
            
            setTimeout(() => {
                window.location.href = "painel.html";
            }, 2000);
        O}

        // ========== UTILIT√ÅRIOS ==========
        function mostrarToast (mensagem) {
            const toast = document.getElementById ('torrada');
            document.getElementById('toast-message').innerTexto = mensagem;
            toast.classList.add('mostrar');
            
            setTimeout(() => {
                toast.classList.remove ('mostrar');
            }, 3000);
        O}
    </roteiro>

</corpo>
</html>