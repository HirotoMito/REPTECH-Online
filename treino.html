<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>REPTECH - Treino Pro</title>
    
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-auth.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-database.js"></script>

    <script src="https://unpkg.com/html5-qrcode" type="text/javascript"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/Sortable/1.14.0/Sortable.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

    <style>
        /* --- VISUAL --- */
        :root { --bg-color: #000000; --card-bg: #111111; --accent-blue: #007AFF; --input-bg: #1C1C1E; --border-color: #2C2C2E; --danger-color: #FF453A; --text-muted: #636366; }
        * { box-sizing: border-box; margin: 0; padding: 0; font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, sans-serif; }
        body { background-color: var(--bg-color); color: white; padding-bottom: 120px; }

        header { display: flex; justify-content: space-between; align-items: center; padding: 15px 20px; background-color: var(--bg-color); border-bottom: 1px solid var(--border-color); position: sticky; top: 0; z-index: 50; }
        .header-left { display: flex; align-items: center; gap: 15px; }
        .header-title { font-weight: 800; font-size: 18px; letter-spacing: 0.5px; }
        .btn-save-routine { background: transparent; border: none; font-size: 22px; cursor: pointer; padding: 0; }
        .btn-finish { background-color: var(--accent-blue); color: white; border: none; padding: 8px 16px; border-radius: 20px; font-weight: 600; font-size: 13px; cursor: pointer; }

        .stats-bar { display: flex; justify-content: space-around; padding: 15px 0; background: var(--bg-color); border-bottom: 8px solid #0a0a0a; }
        .stat-item { text-align: center; }
        .stat-item small { color: #8E8E93; font-size: 10px; text-transform: uppercase; display: block; margin-bottom: 4px; }
        .stat-item span { display: block; font-size: 18px; font-weight: 700; font-variant-numeric: tabular-nums; }

        /* EXERC√çCIOS */
        .exercise-container { padding: 20px; border-bottom: 1px solid var(--border-color); background-color: var(--bg-color); }
        .exercise-container.auto-connected { background: linear-gradient(90deg, rgba(0,122,255,0.08) 0%, rgba(0,0,0,0) 100%); border-left: 3px solid var(--accent-blue); }
        .exercise-header-top { display: flex; align-items: center; gap: 12px; margin-bottom: 5px; justify-content: space-between; }
        .ex-header-left { display: flex; align-items: center; gap: 12px; flex: 1; overflow: hidden; }
        .exercise-number { width: 28px; height: 28px; background: #333; border-radius: 50%; display: flex; align-items: center; justify-content: center; font-weight: bold; font-size: 14px; color: #ddd; flex-shrink: 0; }
        .exercise-name-btn { font-size: 18px; font-weight: 700; color: var(--accent-blue); background: transparent; border: none; width: 100%; text-align: left; cursor: pointer; overflow: hidden; text-overflow: ellipsis; white-space: nowrap; }
        .btn-options { background: transparent; border: none; color: #fff; font-size: 20px; padding: 5px 10px; cursor: pointer; transform: rotate(90deg); }
        .rest-config-btn { background: transparent; border: none; color: var(--accent-blue); font-size: 13px; font-weight: 600; display: flex; align-items: center; gap: 5px; margin-left: 40px; margin-bottom: 15px; cursor: pointer; opacity: 0.9; }

        .series-table { width: 100%; border-collapse: separate; border-spacing: 0 8px; }
        .series-header th { color: #8E8E93; font-size: 10px; text-transform: uppercase; padding-bottom: 5px; font-weight: normal; }
        .series-row td { padding: 0 4px; text-align: center; vertical-align: middle; }
        .col-prev { color: var(--text-muted); font-size: 13px; font-weight: 500; letter-spacing: 0.5px; }
        input[type="number"] { width: 100%; background-color: var(--input-bg); border: 1px solid transparent; border-radius: 8px; padding: 12px 0; color: white; text-align: center; font-size: 18px; font-weight: 600; }
        input:focus { border-color: var(--accent-blue); }
        input.active-sensor { border: 1px solid var(--accent-blue); box-shadow: 0 0 10px rgba(0,122,255,0.3); background-color: rgba(0,122,255,0.1); }
        .check-btn { width: 38px; height: 38px; background-color: var(--input-bg); border-radius: 8px; border: none; cursor: pointer; display: flex; align-items: center; justify-content: center; color: #555; }
        .check-btn.completed { background-color: #142E18; color: #30D158; border: 1px solid #1B4020; }
        .check-btn svg { width: 20px; height: 20px; fill: currentColor; }
        .sets-actions { display: flex; gap: 10px; margin-top: 15px; }
        .btn-add-set { flex: 2; background-color: #1C1C1E; color: var(--accent-blue); border: none; padding: 12px; border-radius: 8px; font-weight: 600; cursor: pointer; }
        .btn-remove-set { flex: 1; background-color: #1C1C1E; color: #666; border: none; padding: 12px; border-radius: 8px; font-weight: 600; cursor: pointer; }
        .btn-remove-set:active { background-color: #333; color: var(--danger-color); }
        .btn-add-main { width: 90%; margin: 30px auto; display: block; background-color: var(--accent-blue); color: white; border: none; padding: 16px; border-radius: 12px; font-weight: 700; font-size: 16px; cursor: pointer; }

        /* MODAIS */
        #timer-toast { position: fixed; bottom: 30px; left: 50%; transform: translateX(-50%) translateY(200px); background-color: #222; border: 1px solid #333; padding: 12px 25px; border-radius: 50px; box-shadow: 0 10px 30px rgba(0,0,0,0.9); display: flex; align-items: center; gap: 20px; transition: 0.4s; z-index: 1000; min-width: 250px; justify-content: space-between; }
        #timer-toast.visible { transform: translateX(-50%) translateY(0); }
        .timer-display { font-family: monospace; font-size: 22px; font-weight: bold; color: var(--accent-blue); }
        .timer-label { color: #888; font-size: 11px; text-transform: uppercase; font-weight: 700; }

        .modal-overlay { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.95); z-index: 200; display: none; flex-direction: column; align-items: center; justify-content: center; }
        .modal-card { background: var(--card-bg); width: 95%; max-width: 400px; padding: 20px; border-radius: 20px; text-align: center; border: 1px solid #333; max-height: 90vh; display: flex; flex-direction: column; position: relative; }
        
        /* DETALHES */
        .details-header { display: flex; align-items: center; justify-content: space-between; margin-bottom: 20px; }
        .details-title { font-size: 18px; font-weight: 700; color: white; text-align: left; }
        .details-close { background: transparent; border: none; color: #666; font-size: 24px; cursor: pointer; }
        .details-tabs { display: flex; border-bottom: 1px solid var(--border-color); margin-bottom: 20px; }
        .d-tab-btn { flex: 1; padding: 10px; background: transparent; border: none; color: var(--text-muted); font-weight: 600; cursor: pointer; border-bottom: 2px solid transparent; }
        .d-tab-btn.active { color: var(--accent-blue); border-bottom-color: var(--accent-blue); }
        .d-content-section { display: none; overflow-y: auto; }
        .d-content-section.active { display: block; }
        .chart-box { height: 200px; width: 100%; margin-bottom: 20px; }
        .stats-grid { display: grid; grid-template-columns: 1fr; gap: 10px; margin-bottom: 20px; }
        .d-stat-row { display: flex; justify-content: space-between; padding: 12px; background: #1C1C1E; border-radius: 8px; border: 1px solid #333; align-items: center; }
        .d-stat-label { color: var(--text-muted); font-size: 12px; }
        .d-stat-value { font-size: 16px; font-weight: 700; color: var(--accent-blue); }
        .history-item { padding: 12px; border-bottom: 1px solid #222; text-align: left; }
        .history-date { font-size: 11px; color: var(--text-muted); margin-bottom: 4px; font-weight: bold; }
        .history-set { display: flex; justify-content: space-between; font-size: 13px; margin-bottom: 2px; color: #ddd; }

        /* OUTROS */
        .options-menu { display: flex; flex-direction: column; gap: 5px; text-align: left; }
        .option-item { padding: 18px; background: #222; border-radius: 12px; font-size: 16px; display: flex; align-items: center; gap: 15px; cursor: pointer; border: 1px solid transparent; }
        .option-item:active { background: #333; }
        .option-item.danger { color: var(--danger-color); border-color: rgba(255, 69, 58, 0.2); }
        
        .reorder-list { list-style: none; padding: 0; margin: 0; overflow-y: auto; max-height: 60vh; }
        .reorder-item { background: #1C1C1E; margin-bottom: 10px; padding: 15px; border-radius: 10px; display: flex; justify-content: space-between; align-items: center; border: 1px solid #333; }
        .reorder-handle { color: #666; font-size: 24px; cursor: grab; padding: 0 10px; }
        
        .filter-header { display: flex; gap: 10px; margin-bottom: 15px; }
        .btn-filter-pill { flex: 1; background: #222; color: white; border: 1px solid #333; padding: 10px; border-radius: 8px; font-size: 14px; cursor: pointer; display: flex; justify-content: space-between; align-items: center; }
        .ex-search-input { width: 100%; padding: 12px; background: #1C1C1E; border: 1px solid #333; border-radius: 8px; color: white; font-size: 16px; margin-bottom: 10px; }
        .ex-list-container { overflow-y: auto; flex: 1; text-align: left; margin-top: 5px; }
        .ex-list-item { padding: 10px; border-bottom: 1px solid #222; color: #eee; cursor: pointer; font-size: 15px; display: flex; align-items: center; gap: 15px; }
        .ex-list-item:active { background: #222; }
        .ex-thumb { width: 50px; height: 50px; border-radius: 6px; object-fit: cover; background: transparent; }
        .ex-thumb:not([src]), .ex-thumb[src=""] { display: none; }
        .ex-text-group { display: flex; flex-direction: column; }
        .ex-text-group small { color: #666; font-size: 11px; }

        #category-list { display: none; flex-direction: column; text-align: left; overflow-y: auto; }
        .cat-item { padding: 15px; border-bottom: 1px solid #222; font-size: 16px; cursor: pointer; display: flex; align-items: center; gap: 10px; }
        .cat-icon { width: 30px; height: 30px; background: #222; border-radius: 50%; display: flex; align-items: center; justify-content: center; font-size: 12px; }

        .badge { font-size: 9px; padding: 3px 6px; border-radius: 4px; text-transform: uppercase; font-weight: bold; margin-left: auto; }
        .badge-auto { background: var(--accent-blue); color: white; }
        .badge-manual { background: #333; color: #777; }
    </style>
</head>
<body>

    <header>
        <div class="header-left">
            <button class="btn-save-routine" onclick="saveRoutine()">üíæ</button>
            <span class="header-title">Meu Treino</span>
        </div>
        <button class="btn-finish" onclick="finishWorkout()">Concluir</button>
    </header>

    <div class="stats-bar">
        <div class="stat-item"><small>Dura√ß√£o</small><span id="timer-duration">00:00:00</span></div>
        <div class="stat-item"><small>Volume</small><span id="total-vol">0 kg</span></div>
        <div class="stat-item"><small>S√©ries</small><span id="total-sets">0</span></div>
    </div>

    <div id="workout-list"></div>

    <button class="btn-add-main" onclick="openModal()">+ ADICIONAR EXERC√çCIO</button>

    <div id="timer-toast">
        <div><span class="timer-label">Descanso</span></div>
        <span class="timer-display" id="rest-countdown">00:00</span>
        <button onclick="stopRest()" style="background:transparent; border:none; color:white; font-size:24px; cursor:pointer;">&times;</button>
    </div>

    <div class="modal-overlay" id="modal-details">
        <div class="modal-card" style="height: 90vh; padding: 20px;">
            <div class="details-header">
                <span class="details-title" id="details-title">Exerc√≠cio</span>
                <button class="details-close" onclick="closeDetailsModal()">&times;</button>
            </div>
            
            <div class="details-tabs">
                <button class="d-tab-btn active" onclick="switchDetailTab('resumo')">Resumo</button>
                <button class="d-tab-btn" onclick="switchDetailTab('historico')">Hist√≥rico</button>
            </div>

            <div id="d-resumo" class="d-content-section active">
                <div class="chart-box">
                    <canvas id="progressionChart"></canvas>
                </div>
                <h4 style="text-align:left; margin-bottom:10px;">Recordes Pessoais</h4>
                <div class="stats-grid">
                    <div class="d-stat-row">
                        <span class="d-stat-label">Maior Carga</span>
                        <span class="d-stat-value" id="stat-max-weight">-</span>
                    </div>
                    <div class="d-stat-row">
                        <span class="d-stat-label">Melhor 1RM (Est.)</span>
                        <span class="d-stat-value" id="stat-1rm">-</span>
                    </div>
                </div>
            </div>

            <div id="d-historico" class="d-content-section">
                <div id="details-history-list">
                    <p style="color:#666; font-size:14px; margin-top:20px;">Carregando...</p>
                </div>
            </div>
        </div>
    </div>

    <div class="modal-overlay" id="modal-add">
        <div class="modal-card" style="height: auto;">
            <h3 style="margin-bottom:20px;">Novo Exerc√≠cio</h3>
            <div id="reader" style="display:none; width:100%; border-radius:10px; overflow:hidden; margin-bottom:10px;"></div>
            <div id="scan-status" style="display:none; color:#666; font-size:12px; margin-bottom:10px; text-align:center;">Aponte a c√¢mera para o QR Code</div>
            
            <div id="modal-buttons">
                <button onclick="startScanner()" style="width:100%; padding:15px; margin-bottom:10px; background:var(--accent-blue); border:none; border-radius:10px; color:white; font-weight:bold;">üì∑ Conectar M√°quina</button>
                <button onclick="addManualExercise()" style="width:100%; padding:15px; background:#222; border:none; border-radius:10px; color:white; font-weight:bold;">‚úèÔ∏è Manual / Livre</button>
            </div>
            <button onclick="closeModal()" style="margin-top:15px; background:none; border:none; color:#666; padding:10px;">Cancelar</button>
        </div>
    </div>

    <div class="modal-overlay" id="modal-time">
        <div class="modal-card">
            <span style="font-size: 18px; font-weight: bold; display: block; margin-bottom: 20px; color:white;">Tempo de Descanso</span>
            <div style="display: grid; grid-template-columns: 1fr 1fr 1fr; gap: 10px;">
                <button style="background:#1C1C1E; border:1px solid #333; color:white; padding:15px; border-radius:10px;" onclick="selectRestTime(30)">30s</button>
                <button style="background:#1C1C1E; border:1px solid #333; color:white; padding:15px; border-radius:10px;" onclick="selectRestTime(45)">45s</button>
                <button style="background:#1C1C1E; border:1px solid #333; color:white; padding:15px; border-radius:10px;" onclick="selectRestTime(60)">60s</button>
                <button style="background:#1C1C1E; border:1px solid #333; color:white; padding:15px; border-radius:10px;" onclick="selectRestTime(90)">1m30</button>
                <button style="background:#1C1C1E; border:1px solid #333; color:white; padding:15px; border-radius:10px;" onclick="selectRestTime(120)">2m</button>
                <button style="background:#1C1C1E; border:1px solid #333; color:white; padding:15px; border-radius:10px;" onclick="selectRestTime(180)">3m</button>
            </div>
            <button onclick="closeTimeModal()" style="margin-top:15px; background:none; border:none; color:#666;">Cancelar</button>
        </div>
    </div>

    <div class="modal-overlay" id="modal-exercises">
        <div class="modal-card" style="height: 85vh; padding: 20px 15px;">
            <div class="filter-header">
                <button class="btn-filter-pill" onclick="toggleCategoryMenu()">
                    <span id="filter-label">Todos os M√∫sculos</span>
                    <span>‚ñæ</span>
                </button>
            </div>
            <input type="text" id="ex-search" class="ex-search-input" placeholder="Procurar exerc√≠cio..." oninput="filterExercises()">
            <div class="ex-list-container" id="ex-list"></div>
            <div class="ex-list-container" id="category-list" style="display:none;">
                <div class="cat-item" onclick="setCategory('Todos')"><div class="cat-icon">‚ôæÔ∏è</div> Todos os M√∫sculos</div>
            </div>
            <button onclick="closeExModal()" style="margin-top:10px; background:none; border:none; color:#666;">Fechar</button>
        </div>
    </div>

    <div class="modal-overlay" id="modal-options">
        <div class="modal-card" style="height: auto; padding-bottom: 30px;">
            <h3 style="margin-bottom:20px;">Op√ß√µes</h3>
            <div class="options-menu">
                <div class="option-item" onclick="openReorderModal()"><span>‚Üï</span> Reordenar Exerc√≠cios</div>
                <div class="option-item" onclick="openReplaceModal()"><span>üîÑ</span> Substituir Exerc√≠cio</div>
                <div class="option-item danger" onclick="removeCurrentExercise()"><span>‚ùå</span> Remover Exerc√≠cio</div>
            </div>
            <button onclick="closeOptionsModal()" style="margin-top:20px; background:none; border:none; color:#666;">Cancelar</button>
        </div>
    </div>

    <div class="modal-overlay" id="modal-reorder">
        <div class="modal-card" style="height: 80vh;">
            <h3 style="margin-bottom:15px;">Reordenar</h3>
            <p style="color:#666; font-size:12px; margin-bottom:15px;">Arraste para mudar a ordem</p>
            <ul id="reorder-list" class="reorder-list"></ul>
            <button onclick="saveReorder()" style="width:100%; padding:15px; background:var(--accent-blue); border:none; border-radius:10px; color:white; font-weight:bold; margin-top:15px;">Concluir</button>
        </div>
    </div>

    <script>
        // Verifica se todas as bibliotecas foram carregadas
        window.addEventListener('DOMContentLoaded', function() {
            console.log("Firebase carregado:", typeof firebase !== 'undefined');
            console.log("Html5Qrcode carregado:", typeof Html5Qrcode !== 'undefined');
            console.log("Sortable carregado:", typeof Sortable !== 'undefined');
            console.log("Chart.js carregado:", typeof Chart !== 'undefined');
        });

        // --- CONFIGURA√á√ÉO DO BANCO DE EXERC√çCIOS ---
        const exerciseDB = {
            "Peitoral": [
                { name: "Crucifixo (Cross Over) com Halteres", img: "https://upload.wikimedia.org/wikipedia/commons/7/74/DumbbellFlye.gif" },
                { name: "Supino Reto com Barra", img: "https://i.pinimg.com/originals/8e/34/bb/8e34bb41d30ceb2f65aa7873a87a4371.gif" },
                "Supino Inclinado com Barra", "Supino Declinado com Barra", "Supino Reto com Halteres", "Supino Inclinado com Halteres", "Supino Declinado com Halteres",
                "Flex√£o de Bra√ßo (Barra Fixa)", "Mergulho entre Bancos (Paralelas)", "Pullover com Haltere", "Supino M√°quina (Guizado)", "Voador (Peck-Deck)", "Cross Over (Polia)"
            ],
            "Costas": [
                "Barra Fixa (Pronada/Supinada)", "Puxada Alta com Barra", "Remada Curvada com Barra", "Remada Unilateral com Haltere", "Remada Serrote", "Pullover com Haltere",
                "Pulley Frente (Puxada Alta)", "Pulley Atr√°s", "Remada M√°quina", "Remada Cavalinho"
            ],
            "Ombros": [
                "Desenvolvimento Militar", "Desenvolvimento com Halteres", "Eleva√ß√£o Lateral", "Eleva√ß√£o Frontal", "Remada Alta", "Crucifixo Invertido", "Encolhimento (Shrug)"
            ],
            "Pernas": [
                "Agachamento Livre", "Agachamento Frontal", "Agachamento Sum√¥", "Afundo (Lunge)", "Passada (Walking Lunge)", "Agachamento B√∫lgaro", "Agachamento Hack",
                "Cadeira Extensora", "Leg Press 45¬∞", "M√°quina Smith", "Stiff", "Mesa Flexora", "Eleva√ß√£o P√©lvica", "Cadeira Flexora", "Panturrilha em P√©"
            ],
            "Bra√ßos": [
                "Rosca Direta", "Rosca Alternada", "Rosca Scott", "Rosca Concentrada", "Rosca Martelo", "Tr√≠ceps Pulley", "Tr√≠ceps Corda", "Tr√≠ceps Testa", "Tr√≠ceps Coice"
            ],
            "Abd√¥men": [
                "Prancha", "Abdominal Crunch", "Abdominal Reverso", "Abdominal Bicicleta", "Russian Twist", "Mountain Climber"
            ]
        };

        // API KEY
        const firebaseConfig = {
            apiKey: "AIzaSyDo2Vhtj4aldfEr6CHoXVWP4fhhC1GZZIo",
            authDomain: "reptech-mvp.firebaseapp.com",
            databaseURL: "https://reptech-mvp-default-rtdb.firebaseio.com",
            projectId: "reptech-mvp",
            storageBucket: "reptech-mvp.firebasestorage.app",
            messagingSenderId: "350784354776",
            appId: "1:350784354776:web:6d7c99682b8e0980ec1aad",
            measurementId: "G-9Q9J9WRBMZ"
        };
        if (!firebase.apps.length) firebase.initializeApp(firebaseConfig);
        const auth = firebase.auth();
        const db = firebase.database();

        let currentUser = null;
        let exCount = 0;
        let html5QrcodeScanner = null;
        const workoutSessionId = Date.now(); 
        let startTime = new Date();
        let workoutInterval, restInterval;
        let currentEditingBlockId = null;
        let currentOptionsBlockId = null;
        let currentExButtonId = null;
        let activeCategory = "Todos";
        let isCategoryMenuOpen = false;
        let myChart = null;

        auth.onAuthStateChanged(user => {
            if (user) { 
                currentUser = user; 
                startWorkoutTimer(); 
                const urlParams = new URLSearchParams(window.location.search);
                const routineId = urlParams.get('rotina');
                if(routineId) loadRoutine(routineId);
            } 
            else { window.location.href = "index.html"; }
        });

        function startWorkoutTimer() {
            workoutInterval = setInterval(() => {
                const now = new Date(); const diff = Math.floor((now - startTime) / 1000);
                const h = Math.floor(diff / 3600).toString().padStart(2,'0');
                const m = Math.floor((diff % 3600) / 60).toString().padStart(2,'0');
                const s = (diff % 60).toString().padStart(2,'0');
                document.getElementById('timer-duration').innerText = `${h}:${m}:${s}`;
            }, 1000);
        }

        // --- MODAIS E SCANNER - VERS√ÉO CORRIGIDA ---
        function openModal() { 
            console.log("Modal aberto - funcionando!");
            document.getElementById('modal-add').style.display = 'flex'; 
        }

        function closeModal() { 
            document.getElementById('modal-add').style.display = 'none'; 
            stopScanner(); 
        }

        function startScanner() { 
            console.log("Scanner iniciado");
            document.getElementById('modal-buttons').style.display = 'none';
            document.getElementById('reader').style.display = 'block';
            document.getElementById('scan-status').style.display = 'block';
            
            // Verifica se a API est√° dispon√≠vel
            if(!window.Html5Qrcode) {
                alert("Erro: Biblioteca de scanner n√£o carregada. Verifique sua conex√£o.");
                return;
            }
            
            html5QrcodeScanner = new Html5Qrcode("reader");
            html5QrcodeScanner.start(
                { facingMode: "environment" }, 
                { 
                    fps: 10, 
                    qrbox: { width: 250, height: 250 }
                }, 
                onScanSuccess
            ).catch(err => { 
                console.error("Erro no scanner:", err);
                alert("N√£o foi poss√≠vel acessar a c√¢mera: " + err);
                stopScanner();
            });
        }

        function stopScanner() { 
            if (html5QrcodeScanner) {
                html5QrcodeScanner.stop().then(() => {
                    html5QrcodeScanner.clear();
                    html5QrcodeScanner = null;
                }).catch(err => {
                    console.error("Erro ao parar scanner:", err);
                    html5QrcodeScanner = null;
                });
            }
            document.getElementById('modal-buttons').style.display = 'block';
            document.getElementById('reader').style.display = 'none';
            document.getElementById('scan-status').style.display = 'none';
        }

        function onScanSuccess(decodedText) {
            console.log("QR Code lido:", decodedText);
            let machineId = decodedText;
            
            // Extrai o ID da URL se for um QR code completo
            if(decodedText.includes('?id=')) {
                machineId = decodedText.split('?id=')[1];
            }
            
            stopScanner();
            closeModal();
            addAutoExercise(machineId.trim().toUpperCase());
        }

        function addManualExercise() {
            console.log("Exerc√≠cio manual adicionado");
            closeModal();
            createExerciseBlock("Manual", "Manual");
        }

        // --- L√ìGICA DOS DETALHES/GR√ÅFICO ---
        function handleNameClick(btnId) {
            const btn = document.getElementById(btnId);
            const name = btn.innerText;
            if(name.includes("Toque para selecionar")) {
                openExModal(btnId);
            } else {
                openDetailsModal(name);
            }
        }

        function openDetailsModal(name) {
            document.getElementById('details-title').innerText = name;
            document.getElementById('modal-details').style.display = 'flex';
            loadDetailsData(name);
        }

        function closeDetailsModal() { document.getElementById('modal-details').style.display = 'none'; }

        function switchDetailTab(tab) {
            document.querySelectorAll('.d-tab-btn').forEach(b => b.classList.remove('active'));
            document.querySelectorAll('.d-content-section').forEach(c => c.classList.remove('active'));
            if(tab === 'resumo') {
                document.querySelector('.d-tab-btn:nth-child(1)').classList.add('active');
                document.getElementById('d-resumo').classList.add('active');
            } else {
                document.querySelector('.d-tab-btn:nth-child(2)').classList.add('active');
                document.getElementById('d-historico').classList.add('active');
            }
        }

        function loadDetailsData(name) {
            db.ref(`usuarios/${currentUser.uid}/historico`).orderByChild('exercicio').equalTo(name).once('value').then(snapshot => {
                const data = snapshot.val();
                if(!data) {
                    document.getElementById('details-history-list').innerHTML = "<p style='color:#666; text-align:center;'>Sem dados ainda.</p>";
                    document.getElementById('stat-max-weight').innerText = "-";
                    document.getElementById('stat-1rm').innerText = "-";
                    if(myChart) { myChart.destroy(); myChart = null; }
                    return;
                }
                const records = Object.values(data);
                records.sort((a, b) => new Date(a.data) - new Date(b.data));

                let maxWeight = 0;
                let max1RM = 0;
                const chartLabels = [];
                const chartData = [];
                const historyGrouped = {};

                records.forEach(rec => {
                    const kg = parseFloat(rec.carga) || 0;
                    const reps = parseFloat(rec.repeticoes) || 0;
                    const dateStr = new Date(rec.data).toLocaleDateString('pt-BR', {day:'2-digit', month:'2-digit'});
                    
                    if (kg > maxWeight) maxWeight = kg;
                    const est1RM = kg * (1 + reps/30);
                    if (est1RM > max1RM) max1RM = est1RM;

                    chartLabels.push(dateStr);
                    chartData.push(kg);

                    const sessionKey = rec.sessaoId || dateStr;
                    if(!historyGrouped[sessionKey]) {
                        historyGrouped[sessionKey] = { date: new Date(rec.data).toLocaleString('pt-BR'), sets: [] };
                    }
                    historyGrouped[sessionKey].sets.push({ kg, reps });
                });

                document.getElementById('stat-max-weight').innerText = `${maxWeight} kg`;
                document.getElementById('stat-1rm').innerText = `${max1RM.toFixed(1)} kg`;

                renderChart(chartLabels, chartData);
                renderHistoryList(Object.values(historyGrouped).reverse());
            });
        }

        function renderChart(labels, dataPoints) {
            const ctx = document.getElementById('progressionChart').getContext('2d');
            if(myChart) myChart.destroy();
            myChart = new Chart(ctx, {
                type: 'line',
                data: {
                    labels: labels,
                    datasets: [{
                        label: 'Carga (kg)',
                        data: dataPoints,
                        borderColor: '#007AFF',
                        backgroundColor: 'rgba(0, 122, 255, 0.1)',
                        borderWidth: 2,
                        pointRadius: 3,
                        tension: 0.3,
                        fill: true
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: { legend: { display: false } },
                    scales: {
                        y: { grid: { color: '#222' }, ticks: { color: '#666' } },
                        x: { grid: { display: false }, ticks: { color: '#666' } }
                    }
                }
            });
        }

        function renderHistoryList(sessions) {
            const container = document.getElementById('details-history-list');
            let html = "";
            sessions.forEach(session => {
                html += `<div class="history-item"><div class="history-date">${session.date}</div>`;
                session.sets.forEach((set, idx) => {
                    html += `<div class="history-set"><span>S√©rie ${idx+1}</span><span style="font-weight:bold; color:#007AFF;">${set.kg}kg x ${set.reps}</span></div>`;
                });
                html += `</div>`;
            });
            container.innerHTML = html;
        }

        function loadRoutine(id) {
            db.ref(`usuarios/${currentUser.uid}/rotinas/${id}`).once('value').then(snapshot => {
                const routine = snapshot.val();
                if(routine && routine.exercicios) {
                    document.getElementById('workout-list').innerHTML = "";
                    exCount = 0;
                    routine.exercicios.forEach(ex => {
                        let type = (ex.machineId && ex.machineId !== "Manual") ? "Autom√°tico" : "Manual";
                        createExerciseBlock(ex.machineId, type, ex.name, ex.restTime);
                    });
                }
            });
        }

        function loadPreviousStats(exerciseName, containerId) {
            if(!currentUser || exerciseName.includes("Toque para")) return;
            db.ref(`usuarios/${currentUser.uid}/historico`).orderByChild('exercicio').equalTo(exerciseName).limitToLast(20).once('value').then(snapshot => {
                if(!snapshot.exists()) return;
                const data = snapshot.val();
                const sessions = {};
                Object.values(data).forEach(record => {
                    if(record.sessaoId && record.sessaoId == workoutSessionId) return;
                    const key = record.sessaoId || new Date(record.data).toLocaleDateString();
                    if(!sessions[key]) sessions[key] = [];
                    sessions[key].push(record);
                });
                const sortedSessionKeys = Object.keys(sessions).sort((a,b) => (sessions[b][0].sessaoId || 0) - (sessions[a][0].sessaoId || 0));
                if(sortedSessionKeys.length === 0) return;
                const lastSession = sessions[sortedSessionKeys[0]];
                lastSession.sort((a,b) => new Date(a.data) - new Date(b.data));
                const block = document.getElementById(`ex-block-${containerId}`);
                if(!block) return;
                const rows = block.querySelectorAll('.series-row');
                rows.forEach((row, index) => {
                    const prevCell = row.querySelector('.prev-data');
                    if(lastSession[index]) { prevCell.innerText = `${lastSession[index].carga}kg x ${lastSession[index].repeticoes}`; } 
                    else { prevCell.innerText = "-"; }
                });
            });
        }

        // --- LISTA E CATEGORIAS ---
        function openExModal(btnId) { 
            currentExButtonId = btnId; 
            document.getElementById('modal-exercises').style.display = 'flex'; 
            activeCategory = "Todos"; 
            isCategoryMenuOpen = false; 
            toggleCategoryMenu(false); 
            renderCategories(); 
            filterExercises(); 
        }

        function closeExModal() { document.getElementById('modal-exercises').style.display = 'none'; }

        function toggleCategoryMenu(forceState) { 
            const listDiv = document.getElementById('ex-list'); 
            const menuDiv = document.getElementById('category-list'); 
            const searchInput = document.getElementById('ex-search'); 
            if (typeof forceState !== 'undefined') isCategoryMenuOpen = forceState; 
            else isCategoryMenuOpen = !isCategoryMenuOpen; 
            
            if (isCategoryMenuOpen) { 
                listDiv.style.display = 'none'; 
                searchInput.style.display = 'none'; 
                menuDiv.style.display = 'flex'; 
            } else { 
                listDiv.style.display = 'block'; 
                searchInput.style.display = 'block'; 
                menuDiv.style.display = 'none'; 
            } 
        }

        function renderCategories() { 
            const menuDiv = document.getElementById('category-list'); 
            let html = `<div class="cat-item" onclick="setCategory('Todos')"><div class="cat-icon">‚ôæÔ∏è</div> Todos os M√∫sculos</div>`; 
            if(typeof exerciseDB !== 'undefined') { 
                Object.keys(exerciseDB).forEach(cat => { 
                    let icon = "üí™"; 
                    if(cat.includes("Pernas")) icon = "ü¶µ"; 
                    if(cat.includes("Peito")) icon = "üëï"; 
                    if(cat.includes("Costas")) icon = "üîô"; 
                    html += `<div class="cat-item" onclick="setCategory('${cat}')"><div class="cat-icon">${icon}</div> ${cat}</div>`; 
                }); 
            } 
            menuDiv.innerHTML = html; 
        }

        function setCategory(cat) { 
            activeCategory = cat; 
            document.getElementById('filter-label').innerText = cat === "Todos" ? "Todos os M√∫sculos" : cat; 
            toggleCategoryMenu(false); 
            filterExercises(); 
        }

        function filterExercises() { 
            const term = document.getElementById('ex-search').value.toLowerCase(); 
            const listContainer = document.getElementById('ex-list'); 
            let html = ""; 
            if(typeof exerciseDB !== 'undefined') { 
                Object.keys(exerciseDB).forEach(cat => { 
                    if(activeCategory === "Todos" || activeCategory === cat) { 
                        exerciseDB[cat].forEach(ex => { 
                            let name = (typeof ex === 'string') ? ex : ex.name; 
                            let imgHTML = ""; 
                            if(typeof ex === 'object' && ex.img) imgHTML = `<img src="${ex.img}" class="ex-thumb" onerror="this.style.display='none'">`; 
                            if(name.toLowerCase().includes(term)) { 
                                html += `<div class="ex-list-item" onclick="selectExercise('${name}')">${imgHTML}<div class="ex-text-group"><span>${name}</span><small>${cat}</small></div></div>`; 
                            } 
                        }); 
                    } 
                }); 
            } 
            if(html === "" && term.length > 0) html = `<div class="ex-list-item" onclick="selectExercise('${term}')" style="color:var(--accent-blue);"><span>+ Criar "${term}"</span></div>`; 
            listContainer.innerHTML = html; 
        }
        
        function selectExercise(name) { 
            if(currentExButtonId) { 
                const btn = document.getElementById(currentExButtonId); 
                if(btn) {
                    btn.innerText = name; 
                    btn.value = name;
                    const blockId = currentExButtonId.split('-')[2];
                    loadPreviousStats(name, blockId);
                }
            } 
            closeExModal(); 
        }

        // --- OP√á√ïES E REORDENA√á√ÉO ---
        function openOptionsModal(blockId) { currentOptionsBlockId = blockId; document.getElementById('modal-options').style.display = 'flex'; }
        function closeOptionsModal() { document.getElementById('modal-options').style.display = 'none'; currentOptionsBlockId = null; }
        function removeCurrentExercise() { if(currentOptionsBlockId && confirm("Remover este exerc√≠cio?")) { document.getElementById(`ex-block-${currentOptionsBlockId}`).remove(); calculateStats(); closeOptionsModal(); } }
        function openReplaceModal() { const idToReplace = currentOptionsBlockId; if(idToReplace) { closeOptionsModal(); openExModal(`btn-name-${idToReplace}`); } }
        function openReorderModal() {
            closeOptionsModal(); const container = document.getElementById('reorder-list'); container.innerHTML = "";
            document.querySelectorAll('.exercise-container').forEach(ex => {
                const id = ex.id; const name = ex.querySelector('.exercise-name-btn').innerText;
                const li = document.createElement('li'); li.className = 'reorder-item'; li.setAttribute('data-id', id);
                li.innerHTML = `<span style="font-weight:bold;">${name}</span><span class="reorder-handle">‚ò∞</span>`;
                container.appendChild(li);
            });
            document.getElementById('modal-reorder').style.display = 'flex';
            new Sortable(container, { handle: '.reorder-handle', animation: 150 });
        }
        function saveReorder() {
            const list = document.getElementById('reorder-list'); const mainContainer = document.getElementById('workout-list');
            Array.from(list.children).forEach(li => { mainContainer.appendChild(document.getElementById(li.getAttribute('data-id'))); });
            let count = 1; mainContainer.querySelectorAll('.exercise-number').forEach(num => num.innerText = count++);
            document.getElementById('modal-reorder').style.display = 'none';
        }

        // --- TEMPO DE DESCANSO ---
        function openTimeModal(blockId) { currentEditingBlockId = blockId; document.getElementById('modal-time').style.display = 'flex'; }
        function closeTimeModal() { document.getElementById('modal-time').style.display = 'none'; currentEditingBlockId = null; }
        function selectRestTime(seconds) { if (currentEditingBlockId) { const block = document.getElementById(`ex-block-${currentEditingBlockId}`); block.setAttribute('data-rest', seconds); let text = `${seconds}s`; if(seconds >= 60) text = `${Math.floor(seconds/60)}min ${seconds%60 > 0 ? seconds%60+'s' : ''}`; document.getElementById(`btn-rest-${currentEditingBlockId}`).innerHTML = `‚è± Tempo de Descanso: ${text}`; } closeTimeModal(); }

        // --- CRIA√á√ÉO DE EXERC√çCIOS ---
        function addAutoExercise(machineId) { createExerciseBlock(machineId, "Autom√°tico"); }

        function createExerciseBlock(machineId, type, loadedName = null, loadedRest = null) {
            exCount++;
            const container = document.getElementById('workout-list');
            const isAuto = (type === "Autom√°tico"); const extraClass = isAuto ? "auto-connected" : ""; const badgeClass = isAuto ? "badge-auto" : "badge-manual"; 
            const defaultName = loadedName ? loadedName : (isAuto ? `M√°quina (${machineId})` : "Toque para selecionar...");
            const defaultRest = loadedRest ? loadedRest : "60";
            let restText = `${defaultRest}s`;
            if(parseInt(defaultRest) >= 60) restText = `${Math.floor(parseInt(defaultRest)/60)}min ${parseInt(defaultRest)%60 > 0 ? parseInt(defaultRest)%60+'s' : ''}`;

            const html = `
            <div class="exercise-container ${extraClass}" id="ex-block-${exCount}" data-machine="${machineId || ''}" data-rest="${defaultRest}">
                <div class="exercise-header-top">
                    <div class="ex-header-left"><div class="exercise-number">${exCount}</div><button id="btn-name-${exCount}" class="exercise-name-btn" onclick="handleNameClick('btn-name-${exCount}')">${defaultName}</button></div>
                    <div style="display:flex; align-items:center; gap:10px;"><span class="badge ${badgeClass}">${type}</span><button class="btn-options" onclick="openOptionsModal(${exCount})">‚ãÆ</button></div>
                </div>
                <button class="rest-config-btn" id="btn-rest-${exCount}" onclick="openTimeModal(${exCount})">‚è± Tempo de Descanso: ${restText}</button>
                <table class="series-table"><thead><tr class="series-header"><th>S√âRIE</th><th>ANTERIOR</th><th>KG</th><th>REPS</th><th>OK</th></tr></thead><tbody id="tbody-${exCount}">${createRowHTML(1)}</tbody></table>
                <div class="sets-actions"><button class="btn-remove-set" onclick="removeSet(${exCount})">üóë Remover</button><button class="btn-add-set" onclick="addSet(${exCount})">+ Adicionar</button></div>
            </div>`;
            container.insertAdjacentHTML('beforeend', html);
            if(isAuto && machineId) connectToMachine(machineId, exCount);
            if(loadedName) loadPreviousStats(loadedName, exCount);
            if(!isAuto && !loadedName) setTimeout(() => openExModal(`btn-name-${exCount}`), 100);
        }

        function createRowHTML(num) { return `<tr class="series-row"><td style="font-weight:bold; color:#555;">${num}</td><td class="col-prev"><span class="prev-data">-</span></td><td><input type="number" placeholder="0" class="input-kg" oninput="calculateStats()"></td><td><input type="number" placeholder="0" class="input-reps" oninput="calculateStats()"></td><td><button class="check-btn" onclick="finishSet(this)">‚úî</button></td></tr>`; }

        function addSet(exId) { document.getElementById(`tbody-${exId}`).insertAdjacentHTML('beforeend', createRowHTML(document.getElementById(`tbody-${exId}`).children.length + 1)); const block = document.getElementById(`ex-block-${exId}`); const name = block.querySelector('.exercise-name-btn').innerText; loadPreviousStats(name, exId); }

        function removeSet(exId) { const tbody = document.getElementById(`tbody-${exId}`); if(tbody.children.length > 1) { tbody.removeChild(tbody.lastElementChild); calculateStats(); } }

        function connectToMachine(id, uiId) { db.ref(`equipamentos/${id}/tempo_real/contagem`).on('value', (snapshot) => { const val = snapshot.val(); if(val===null) return; const block = document.getElementById(`ex-block-${uiId}`); if (!block) return; const rows = block.querySelectorAll('.series-row'); for(let row of rows) { if(!row.querySelector('.check-btn').classList.contains('completed')) { const input = row.querySelector('.input-reps'); input.value = val; block.querySelectorAll('.input-reps').forEach(i=>i.classList.remove('active-sensor')); input.classList.add('active-sensor'); calculateStats(); break; } } }); }

        function finishSet(btn) {
            if (!currentUser) return;
            const row = btn.closest('tr'); const inputs = row.querySelectorAll('input'); const block = row.closest('.exercise-container'); const machineId = block.getAttribute('data-machine'); const exNameBtn = block.querySelector('.exercise-name-btn'); const exName = exNameBtn.innerText; const restTime = parseInt(block.getAttribute('data-rest')) || 60;
            if (btn.classList.contains('completed')) { btn.classList.remove('completed'); inputs.forEach(i => i.disabled = false); stopRest(); }
            else { btn.classList.add('completed'); inputs.forEach(i => { i.disabled = true; i.classList.remove('active-sensor'); }); db.ref(`usuarios/${currentUser.uid}/historico`).push({ exercicio: exName, carga: row.querySelector('.input-kg').value || 0, repeticoes: row.querySelector('.input-reps').value || 0, maquina: machineId || "Manual", data: new Date().toISOString(), sessaoId: workoutSessionId }); if (machineId) db.ref(`equipamentos/${machineId}/tempo_real/reset`).set(1); startRest(restTime); }
            calculateStats();
        }

        function startRest(duration) { stopRest(); const toast = document.getElementById('timer-toast'); const display = document.getElementById('rest-countdown'); let timeLeft = duration; toast.classList.add('visible'); display.innerText = `${Math.floor(timeLeft/60)}:${(timeLeft%60).toString().padStart(2,'0')}`; restInterval = setInterval(() => { timeLeft--; display.innerText = `${Math.floor(timeLeft/60)}:${(timeLeft%60).toString().padStart(2,'0')}`; if(timeLeft <= 0) stopRest(); }, 1000); }

        function stopRest() { clearInterval(restInterval); document.getElementById('timer-toast').classList.remove('visible'); }

        function calculateStats() { let totalVol = 0, totalSets = 0; document.querySelectorAll('.series-row').forEach(row => { const kg = parseFloat(row.querySelector('.input-kg').value)||0; const reps = parseFloat(row.querySelector('.input-reps').value)||0; if(kg>0 && reps>0) totalVol += kg*reps; if(row.querySelector('.check-btn').classList.contains('completed')) totalSets++; }); document.getElementById('total-vol').innerText = totalVol + " kg"; document.getElementById('total-sets').innerText = totalSets; }

        function saveRoutine() {
            const exercises = [];
            document.querySelectorAll('.exercise-container').forEach(ex => {
                const name = ex.querySelector('.exercise-name-btn').innerText;
                const machineId = ex.getAttribute('data-machine');
                const restTime = ex.getAttribute('data-rest');
                if(!name.includes("Toque para selecionar")) {
                    exercises.push({ name: name, machineId: machineId, restTime: restTime });
                }
            });
            if(exercises.length === 0) { alert("Adicione exerc√≠cios antes de salvar."); return; }
            const routinesRef = db.ref(`usuarios/${currentUser.uid}/rotinas`);
            routinesRef.get().then(snapshot => {
                if(snapshot.numChildren() >= 3) { alert("Limite de 3 fichas atingido."); }
                else {
                    const routineName = prompt("Nome da Ficha:");
                    if(routineName) {
                        routinesRef.push({ nome: routineName, exercicios: exercises, criadoEm: new Date().toISOString() })
                        .then(() => alert("Ficha salva! üíæ"));
                    }
                }
            });
        }

        function finishWorkout() { if(confirm("Finalizar treino?")) window.location.href = "dashboard.html"; }
    </script>
</body>
</html>